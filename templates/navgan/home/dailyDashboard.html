{% extends "navgan/base/base.html" %}
{% load my_tags %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ{% endblock %}

{% block stylesheets %}




    <style>
        .stat-card {
            background: #dfe4f5;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .chart-card {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .checkbox-row {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            padding-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            user-select: none;
        }

        .checkbox-label input {
            display: none;
        }

        .checkmark {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            border: 2px solid #ccc;
            display: inline-block;
            position: relative;
        }

        .checkmark::after {
            content: "";
            position: absolute;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            left: 3px;
            top: 1px;
            opacity: 0;
        }

        .checkbox-label input:checked + .checkmark::after {
            opacity: 1;
        }

        .check-this {
            background: #008FFB; /* Ø±Ù†Ú¯ Ø®Ø· Ø§Ù…Ø³Ø§Ù„ */
            border-color: #008FFB;
        }

        .check-last {
            background: #00E396; /* Ø±Ù†Ú¯ Ø®Ø· Ø³Ø§Ù„ Ù‚Ø¨Ù„ */
            border-color: #00E396;
        }

        /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ú†Ú©â€ŒØ¨Ø§Ú©Ø³â€ŒÙ‡Ø§ */
        @media (max-width: 576px) {
            .checkbox-row {
                gap: 10px;
            }

            .checkbox-label {
                font-size: 12px;
            }
        }

        .apexcharts-legend-series {
            margin-left: 10px !important;
        }

        .apexcharts-legend-text {
            margin-right: 6px !important;
        }

        {#*************************************************************************************#}

        /* Ú©Ø§Ø±Øª Ø³ÙÛŒØ¯ */
        .confidence-card {
            background: #ffffff;
            border-radius: 8px;
            padding: 12px 14px 10px 14px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        }

        /* ÙÙ‚Ø· Ù†Ø§Ø­ÛŒÙ‡ Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø¨Ø² */
        .conf-chart-wrapper {
            background: #dcefed;
            border-radius: 6px;
            padding: 8px 10px 4px 10px;
            height: 215px;
        }

        /* Ù¾Ø§ÛŒÛŒÙ† Ú©Ø§Ø±Øª */
        .conf-bottom {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-top: 8px;
        }

        /* Ø¯Ø±ØµØ¯Ù‡Ø§ Ø³Ù…Øª Ú†Ù¾ */
        .conf-legend-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-weight: bold;
        }

        .conf-legend-left .item {
            display: flex;
            align-items: center;
            gap: 7px;
            font-size: 13px;
        }

        /* Ù…Ø±Ø¨Ø¹ Ø±Ù†Ú¯ */
        .box {
            width: 14px;
            height: 14px;
            border: 2px solid;
            display: inline-block;
        }

        .y1403 {
            background: #f3b21a;
            border-color: #f3b21a;
        }

        .y1404 {
            background: #546e7a;
            border-color: #546e7a;
        }

        /* Ø¹Ù†ÙˆØ§Ù† Ø±Ø§Ø³Øª Ù¾Ø§ÛŒÛŒÙ† */
        .conf-title {
            font-size: 14px;
            color: #333;
            padding-bottom: 2px;
        }

        .chart-legend-top {
            display: flex;
            justify-content: center;
            gap: 18px;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 6px;
            user-select: none;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            opacity: 1;
            transition: .25s;
        }

        .legend-item.off {
            opacity: .35;
        }

        .legend-color {
            width: 18px;
            height: 10px;
            border: 2px solid;
            background: transparent;
        }

        .legend-last {
            border-color: #f3b21a;
        }

        .legend-this {
            border-color: #546e7a;
        }


        .main-chart-wrapper {
            background: #dcefed;
            border-radius: 8px;
            padding: 12px 16px 10px 8px;
            position: relative;
            height: 350px; /* Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ø±Ø§Ø¨Ø± Apex */
        }


        @media (max-width: 768px) {
            .main-chart-wrapper {
                height: 300px;
            }
        }


        /* ================= HEADER FILTER BAR ================= */


        .top-filter-outer {
            direction: rtl;
            padding: 14px 18px 0 18px;
        }

        /* Ø¨Ù†Ø± Ø¨Ù†ÙØ´ */
        .top-filter-bar {
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, #8e44ad, #9b59b6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .18);
            padding: 0 14px;
        }

        /* Ø¹Ù†ÙˆØ§Ù† ÙˆØ³Ø· */
        .top-filter-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            letter-spacing: .5px;
            white-space: nowrap;
            pointer-events: none;
        }

        /* Ø³ØªÙˆÙ† Ø±Ø§Ø³Øª */
        .top-filter-right {
            margin-left: auto; /* â¬…ï¸ Ú©Ù„ÛŒØ¯ Ø§ØµÙ„ÛŒ Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ† ÙˆØ§Ù‚Ø¹ÛŒ */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Ù„ÛŒØ¨Ù„ */
        .top-filter-label {
            color: #f1e9f8;
            font-size: 13px;
        }

        /* input ØªØ§Ø±ÛŒØ® */
        .top-filter-date {
            height: 30px;
            width: 110px;
            border-radius: 4px;
            border: none;
            outline: none;
            text-align: center;
            font-size: 12px;
        }

        .filter-btn {
            height: 30px;
            padding: 0 12px;
            background: #a07aa9; /* Ø±ÙˆØ´Ù†â€ŒØªØ± Ø§Ø² Ù‚Ø¨Ù„ÛŒ */
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: .2s;
        }

        /* ÙˆÙ‚ØªÛŒ Ù…ÙˆØ³ Ù…ÛŒØ±Ù‡ Ø±ÙˆØ´ â†’ Ø¨Ø§Ø² Ù‡Ù… Ø±ÙˆØ´Ù†â€ŒØªØ± */
        .filter-btn:hover {
            background: #bcadc5;
        }


        /* Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        @media (max-width: 768px) {

            .top-filter-bar {
                height: auto;
                flex-wrap: wrap;
                padding: 10px;
                justify-content: center;
                gap: 6px;
            }

            .top-filter-title {
                position: static;
                transform: none;
                width: 100%;
                text-align: center;
                margin-bottom: 6px;
            }

            .top-filter-right {
                margin-left: 0;
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        {#**************************************************************************************************#}
        .farsi-swal {
            direction: rtl !important;
            font-family: 'Vazir', 'Tahoma', sans-serif !important;
            text-align: center !important;
        }

        .farsi-swal .swal2-title {
            font-size: 1.4rem !important;
        }

        .farsi-swal .swal2-html-container {
            font-size: 1.1rem !important;
        }

        .centered-swal {
            direction: rtl !important;
            font-family: 'Vazir', 'Tahoma', sans-serif !important;
            text-align: right !important;
            max-width: 550px !important; /* Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ ÙˆØ³Ø· ØµÙØ­Ù‡ */
            padding: 2rem !important;
        }

        .centered-swal .swal2-title {
            font-size: 1.6rem !important;
            margin-bottom: 1rem !important;
        }

        .centered-swal .swal2-html-container {
            font-size: 1.15rem !important;
            line-height: 1.6 !important;
        }

        /* Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ backdrop ØªÛŒØ±Ù‡â€ŒØªØ± Ùˆ ÙˆØ§Ø¶Ø­â€ŒØªØ± Ø¨Ø§Ø´Ù‡ */
        .swal2-backdrop {
            background: rgba(0, 0, 0, 0.65) !important; /* ØªÛŒØ±Ù‡â€ŒØªØ± Ø§Ø² Ù¾ÛŒØ´â€ŒÙØ±Ø¶ */
        }

        /* Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ popup Ú©Ù…ÛŒ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ùˆ Ù…Ø±Ú©Ø²ÛŒâ€ŒØªØ± Ø¨Ù‡ Ù†Ø¸Ø± Ø¨ÛŒØ§Ø¯ */
        .swal2-popup {
            border-radius: 16px !important;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4) !important;
        }

        @font-face {
            font-family: 'Vazir';
            src: url('/static/fonts/vazir/Vazirmatn-Bold.ttf') format('ttf');
            font-weight: normal;
            font-style: normal;
        }

    </style>
{% endblock stylesheets %}


{% block content %}




    <div class="top-filter-outer account">

        <div class="top-filter-bar">

            <div class="top-filter-title">
                {{ selected_date|default:"1404-11-26" }}
            </div>

            <div class="top-filter-right">

                <span class="top-filter-label">ØªØ§Ø±ÛŒØ®</span>

                <input class="top-filter-date"
                       type="text"
                       value="" data-jdp>

                <button class="filter-btn" id="btnSearch">Ø¬Ø³ØªØ¬Ùˆ</button>
                <button class="filter-btn" id="btnLastUpdate">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                <button class="filter-btn" id="btnExport">Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´</button>

            </div>

        </div>

    </div>




    <div id="dashboardContainer">

        <div class="container-fluid mt-4 account">

            <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø±ÛŒ -->

            <div class="row text-center mb-4">
                <div class="col-12 col-sm-4 col-md-3 col-lg-3 mb-2">
                    <div class="stat-card" id="stat-puretonkilo">
                        ØªÙ† Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ø®Ø§Ù„Øµ<br>{{ puretonkilo|floatformat:0|to_persian_number }}
                    </div>
                </div>
                <div class="col-12 col-sm-4 col-md-3 col-lg-3 mb-2">
                    <div class="stat-card" id="stat-loadedtonkilo">
                        ØªÙ† Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ø¨Ø§Ø±Ø¯Ø§Ø±<br>{{ loadedtonkilo|floatformat:0|to_persian_number }}
                    </div>
                </div>
                <div class="col-12 col-sm-4 col-md-3 col-lg-2 mb-2">
                    <div class="stat-card" id="stat-confidence">
                        Ø¶Ø±ÛŒØ¨ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†<br>%{{ confidence_factor|floatformat:0|to_persian_number }}
                    </div>
                </div>
                <div class="col-12 col-sm-4 col-md-3 col-lg-2 mb-2">
                    <div class="stat-card" id="stat-availability">
                        Ø¢Ù…Ø§Ø¯Ù‡â€ŒÚ©Ø§Ø±ÛŒ<br>%{{ availability|floatformat:0|to_persian_number }}
                    </div>
                </div>
                <div class="col-12 col-sm-4 col-md-3 col-lg-2 mb-2">
                    <div class="stat-card" id="stat-efficiency">
                        Ø¨Ù‡Ø±Ù‡ ÙˆØ±ÛŒ<br>{{ efficiency|floatformat:0|to_persian_number }}
                    </div>
                </div>
            </div>

            <!-- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ -->
            <div class="row">
                <div class="col-12 col-lg-6 mb-3">
                    <div class="chart-card">
                        <h6>Ù†Ù…ÙˆØ¯Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù„Ú©ÙˆÙ…ÙˆØªÛŒÙˆ Ùˆ Ù†Ø§Ø­ÛŒÙ‡</h6>
                        <div id="barChart1"></div>
                    </div>
                </div>


                <div class="col-12 col-lg-6 mb-3">
                    <div class="chart-card">
                        <h6>Ù†Ù…ÙˆØ¯Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±ÙˆØ²Ø§Ù†Ù‡</h6>

                        <div class="main-chart-wrapper">
                            <div class="chart-legend-top" id="legend-mainChart"></div>
                            <canvas id="mainChart"></canvas>
                        </div>

                        <!-- ğŸ”½ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯ -->

                        <div class="conf-bottom mb-2">
                            <div class="conf-legend-left">
                                <div class="item">
                                    <span class="box y1403"></span>
                                    <span id="avg-last-year-tonkilo">{{ last_avg_tonkilo|floatformat:0|to_persian_number }}</span>
                                </div>
                                <div class="item">
                                    <span class="box y1404"></span>
                                    <span id="avg-this-year-tonkilo">{{ current_avg_tonkilo|floatformat:0|to_persian_number }}</span>
                                </div>
                            </div>
                            <div class="conf-title">ØªÙ† Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ø®Ø§Ù„Øµ</div>
                        </div>

                    </div>
                </div>


            </div>

            <!-- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†ÛŒ -->
            <div class="row">
                <div class="col-12 col-md-4 mb-3">
                    <div class="confidence-card">

                        <div class="conf-chart-wrapper">
                            <div class="chart-legend-top" id="legend-efficiencyChart"></div>
                            <canvas id="efficiencyChart"></canvas>
                        </div>

                        <div class="conf-bottom ">

                            <!-- Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ -->
                            <div class="conf-legend-left">
                                <div class="item">
                                    <span class="box y1403"></span>
                                    <span id="eff-last-year">{{ eff_last_year|floatformat:0|to_persian_number }}</span>
                                    <small></small>
                                </div>
                                <div class="item">
                                    <span class="box y1404"></span>
                                    <span id="eff-this-month">{{ eff_this_month|floatformat:0|to_persian_number }}</span>
                                    <small></small>
                                </div>
                            </div>

                            <div class="conf-title">
                                Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ
                            </div>

                        </div>

                    </div>
                </div>


                <div class="col-12 col-md-4 mb-3">
                    <div class="confidence-card">

                        <div class="conf-chart-wrapper">
                            <div class="chart-legend-top" id="legend-availabilityChart"></div>
                            <canvas id="availabilityChart"></canvas>
                        </div>

                        <div class="conf-bottom">

                            <!-- Ø¢Ù…Ø§Ø¯Ù‡â€ŒÚ©Ø§Ø±ÛŒ -->
                            <div class="conf-legend-left">
                                <div class="item">
                                    <span class="box y1403"></span>
                                    <span id="ava-last-year">{{ avail_last_year|floatformat:0|to_persian_number }} %</span>
                                    <small></small>
                                </div>
                                <div class="item">
                                    <span class="box y1404"></span>
                                    <span id="ava-this-month">{{ avail_this_month|floatformat:0|to_persian_number }} %</span>
                                    <small></small>
                                </div>
                            </div>
                            <div class="conf-title">
                                Ø¢Ù…Ø§Ø¯Ù‡â€ŒÚ©Ø§Ø±ÛŒ
                            </div>

                        </div>

                    </div>
                </div>


                <div class="col-12 col-md-4 mb-3">
                    <div class="confidence-card">

                        <div class="conf-chart-wrapper">
                            <div class="chart-legend-top" id="legend-confidenceChart"></div>
                            <canvas id="confidenceChart"></canvas>
                        </div>

                        <div class="conf-bottom">

                            <!-- Ø¶Ø±ÛŒØ¨ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† -->
                            <div class="conf-legend-left">
                                <div class="item">
                                    <span class="box y1403"></span>
                                    <span id="conf-last-year">{{ conf_last_year|floatformat:0|to_persian_number }} %</span>
                                </div>
                                <div class="item">
                                    <span class="box y1404"></span>
                                    <span id="conf-this-month">{{ conf_this_month|floatformat:0|to_persian_number }} %</span>
                                </div>
                            </div>
                            <div class="conf-title">
                                Ø¶Ø±ÛŒØ¨ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†
                            </div>

                        </div>

                    </div>
                </div>

            </div>

        </div>

    </div>
{% endblock content %}

{% block javascripts %}
    <script src="/static/js/chart.js"></script>
    <script src="/static/js/html2canvas.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function formatNumber(value) {
                if (value === null || value === undefined) return "";
                return Math.round(value).toLocaleString('en-US');
            }

            function buildLegend(chartId, yearLast, yearThis) {
                const el = document.getElementById("legend-" + chartId);
                if (!el) return;
                el.innerHTML = `
                    <div class="legend-item" data-chart="${chartId}" data-index="1">
                        <span class="legend-color legend-last"></span>
                        ${yearLast}
                    </div>
                    <div class="legend-item" data-chart="${chartId}" data-index="0">
                        <span class="legend-color legend-this"></span>
                        ${yearThis}
                    </div>
                `;
            }

            const regionColors = {
                19: "#F6F600", 21: "#FBDA66", 18: "#E0B801", 25: "#B4FE69",
                10: "#33CC33", 11: "#00963F", 12: "#0A6A11", 17: "#00ccff",
                8: "#3568FF", 16: "#0001FD", 23: "#6A1918", 20: "#C30101",
                22: "#FB544E", 13: "#FBD2FE", 14: "#FA9FCA", 15: "#CA64A6",
                9: "#9C34FF", 26: "#B0007D", 30: "#5E045B", 29: "#C5E3B4",
                28: "#C8BFE7", 24: "#264478"
            };

            function showAlert(title, text, icon = 'info', timer = 3000) {
                Swal.fire({
                    title: title,
                    text: text,
                    icon: icon,
                    confirmButtonText: 'Ø¨Ø§Ø´Ù‡',
                    confirmButtonColor: '#3085d6',
                    timer: timer,
                    timerProgressBar: true,
                    position: 'center',
                    backdrop: true,
                    allowOutsideClick: true,
                    allowEscapeKey: true,
                    toast: false,
                    customClass: {
                        popup: 'farsi-swal centered-swal'
                    }
                });
            }

            const chartAreaBG = {
                id: 'chartAreaBG',
                beforeDraw(chart, args, opts) {
                    const {ctx, chartArea} = chart;
                    if (!chartArea) return;
                    ctx.save();
                    ctx.fillStyle = opts.color || '#dcefed';
                    ctx.fillRect(
                        chartArea.left,
                        chartArea.top,
                        chartArea.right - chartArea.left,
                        chartArea.bottom - chartArea.top
                    );
                    ctx.restore();
                }
            };
            let barChartInstance = null;  // Ù…ØªØºÛŒØ± Ø¬Ù‡Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ApexChart
            fetch("/daily-chart")
                .then(r => r.json())
                .then(data => buildBarChart(data));

            function buildBarChart(data) {
                const series = data.regions.map(r => ({name: r.name, data: r.data}));
                const colors = data.regions.map(r => regionColors[r.code]);
                barChartInstance = new ApexCharts(document.querySelector("#barChart1"), {
                    chart: {type: 'bar', height: 350, stacked: true, background: '#f4f6fb'},
                    series: series,
                    colors: colors,
                    dataLabels: {enabled: false},
                    xaxis: {
                        categories: data.loco_name,
                        labels: {rotate: -45, rotateAlways: true, offsetY: 12, offsetX: -8}
                    },
                    yaxis: {
                        max: data.max_number,
                        labels: {formatter: (v) => formatNumber(v)}
                    },
                    legend: {position: 'top', fontSize: '11px'}
                });
                barChartInstance.render();
            }

            fetch("/daily-chartline/")
                .then(r => r.json())
                .then(data => {
                    buildLegend("efficiencyChart", data.last_year, data.year);
                    buildLegend("availabilityChart", data.last_year, data.year);
                    buildLegend("confidenceChart", data.last_year, data.year);
                    buildMainChart(data);
                    buildSmallCharts(data);
                });

            function buildMainChart(data) {
                buildLegend("mainChart", data.last_year, data.year);
                const ctx = document.getElementById("mainChart");
                charts["mainChart"] = new Chart(ctx, {
                    type: 'line',
                    plugins: [chartAreaBG],
                    data: {
                        labels: data.days,
                        datasets: [
                            {
                                label: 'Ø§Ù…Ø³Ø§Ù„',
                                data: data.pure.this,
                                borderColor: '#546e7a',
                                borderWidth: 3,
                                tension: 0.35,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#546e7a'
                            },
                            {
                                label: 'Ø³Ø§Ù„ Ù‚Ø¨Ù„',
                                data: data.pure.last,
                                borderColor: '#f3b21a',
                                borderWidth: 2,
                                tension: 0.35,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#f3b21a'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        layout: {
                            padding: {left: 15, right: 15, top: 10, bottom: 5}
                        },
                        maintainAspectRatio: false,
                        interaction: {mode: 'index', intersect: false},
                        plugins: {
                            legend: {display: false},
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.dataset.label + " : " + formatNumber(ctx.parsed.y)
                                }
                            },
                            chartAreaBG: {color: '#dcefed'}
                        },
                        scales: {
                            x: {
                                offset: true,
                                ticks: {
                                    padding: 18,
                                    maxRotation: 0,
                                    autoSkip: true,
                                    maxTicksLimit: 15
                                },
                                grid: {color: 'rgba(0,0,0,0.05)'}
                            },
                            y: {
                                grace: '8%',
                                ticks: {
                                    padding: 8,
                                    callback: (v) => formatNumber(v)
                                },
                                grid: {color: 'rgba(0,0,0,0.08)'}
                            }
                        }
                    }
                });
            }

            const charts = {};

            function buildSmallCharts(data) {
                buildSmallChart("efficiencyChart", data.eff.this, data.eff.last, data.days);
                buildSmallChart("availabilityChart", data.ava.this, data.ava.last, data.days);
                buildSmallChart("confidenceChart", data.conf.this, data.conf.last, data.days);
            }

            function buildSmallChart(id, thisYear, lastYear, days) {
                const ctx = document.getElementById(id);
                if (!ctx) return;
                charts[id] = new Chart(ctx, {
                    type: 'line',
                    plugins: [chartAreaBG],
                    data: {
                        labels: days,
                        datasets: [
                            {
                                label: 'Ø§Ù…Ø³Ø§Ù„',
                                data: thisYear,
                                borderColor: '#546e7a',
                                backgroundColor: '#546e7a',
                                borderWidth: 3,
                                tension: 0.35,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBorderWidth: 2,
                                pointBackgroundColor: '#ffffff',
                                pointBorderColor: '#546e7a'
                            },
                            {
                                label: 'Ø³Ø§Ù„ Ù‚Ø¨Ù„',
                                data: lastYear,
                                borderColor: '#f3b21a',
                                backgroundColor: '#f3b21a',
                                borderWidth: 2,
                                tension: 0.35,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBorderWidth: 2,
                                pointBackgroundColor: '#ffffff',
                                pointBorderColor: '#f3b21a'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {display: false},
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.dataset.label + " : " + Math.round(ctx.parsed.y) + " %"
                                }
                            },
                            chartAreaBG: {color: '#dcefed'}
                        },
                        scales: {
                            x: {
                                ticks: {
                                    padding: 20,
                                    callback: (v, i) => days[i] % 2 === 1 ? days[i] : "",
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {color: 'rgba(0,0,0,0.08)'}
                            },
                            y: {
                                ticks: {callback: (v) => Math.round(v) + "%"},
                                grid: {color: 'rgba(0,0,0,0.08)'}
                            }
                        }
                    }
                });
            }

                {#function buildSmallChart(id, thisYear, lastYear, days) {#}
                {#    const ctx = document.getElementById(id);#}
                {#    if (!ctx) return;#}
                {##}
                {#    const isEfficiency = id === 'efficiencyChart';  // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ø¯Ø±ØµØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡#}
                {##}
                {#    charts[id] = new Chart(ctx, {#}
                {#        type: 'line',#}
                {#        plugins: [chartAreaBG],#}
                {#        data: {#}
                {#            labels: days,#}
                {#            datasets: [#}
                {#                      {#}
                {#                label: 'Ø§Ù…Ø³Ø§Ù„',#}
                {#                data: thisYear,#}
                {#                borderColor: '#546e7a',#}
                {#                backgroundColor: '#546e7a',#}
                {#                borderWidth: 3,#}
                {#                tension: 0.35,#}
                {#                pointRadius: 4,#}
                {#                pointHoverRadius: 6,#}
                {#                pointBorderWidth: 2,#}
                {#                pointBackgroundColor: '#ffffff',#}
                {#                pointBorderColor: '#546e7a'#}
                {#            },#}
                {#            {#}
                {#                label: 'Ø³Ø§Ù„ Ù‚Ø¨Ù„',#}
                {#                data: lastYear,#}
                {#                borderColor: '#f3b21a',#}
                {#                backgroundColor: '#f3b21a',#}
                {#                borderWidth: 2,#}
                {#                tension: 0.35,#}
                {#                pointRadius: 4,#}
                {#                pointHoverRadius: 6,#}
                {#                pointBorderWidth: 2,#}
                {#                pointBackgroundColor: '#ffffff',#}
                {#                pointBorderColor: '#f3b21a'#}
                {#            }#}
                {#            ]#}
                {#        },#}
                {#        options: {#}
                {#            responsive: true,#}
                {#            maintainAspectRatio: false,#}
                {#            interaction: {#}
                {#                mode: 'index',#}
                {#                intersect: false#}
                {#            },#}
                {#            plugins: {#}
                {#                legend: {display: false},#}
                {#                tooltip: {#}
                {#                    callbacks: {#}
                {#                        label: (ctx) => {#}
                {#                            const value = Math.round(ctx.parsed.y);#}
                {#                            return ctx.dataset.label + " : " + value + (isEfficiency ? "" : " %");#}
                {#                        }#}
                {#                    }#}
                {#                },#}
                {#                chartAreaBG: {color: '#dcefed'}#}
                {#            },#}
                {#            scales: {#}
                {#                x: {#}
                {#                    ticks: {#}
                {#                        padding: 20,#}
                {#                        callback: (v, i) => days[i] % 2 === 1 ? days[i] : "",#}
                {#                        maxRotation: 45,#}
                {#                        minRotation: 45#}
                {#                    },#}
                {#                    grid: {color: 'rgba(0,0,0,0.08)'}#}
                {#                },#}
                {#                y: {#}
                {#                    ticks: {#}
                {#                        callback: (v) => {#}
                {#                            const rounded = Math.round(v);#}
                {#                            return isEfficiency ? rounded : rounded + " %";#}
                {#                        }#}
                {#                    },#}
                {#                    grid: {color: 'rgba(0,0,0,0.08)'}#}
                {#                }#}
                {#            }#}
                {#        }#}
                {#    });#}
                {#}#}

                document.querySelectorAll('.toggleAvg').forEach(cb => {
                    cb.addEventListener('change', function () {
                        const chart = charts[this.dataset.target];
                        if (!chart) return;
                        const index = this.dataset.series === "thisYear" ? 0 : 1;
                        chart.data.datasets[index].hidden = !this.checked;
                        chart.update();
                    });
                });
                document.addEventListener("click", function (e) {
                    const item = e.target.closest(".legend-item");
                    if (!item) return;
                    const chartId = item.dataset.chart;
                    const datasetIndex = parseInt(item.dataset.index);
                    const chart = charts[chartId];
                    if (!chart) return;
                    const meta = chart.getDatasetMeta(datasetIndex);
                    meta.hidden = meta.hidden === null
                        ? !chart.data.datasets[datasetIndex].hidden
                        : null;
                    item.classList.toggle("off");
                    chart.update();
                });

                // ØªØ§Ø¨Ø¹ Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ Apex
                function updateBarChart(barData) {
                    if (barChartInstance) {
                        barChartInstance.updateOptions({
                            xaxis: {categories: barData.loco_name},
                            series: barData.regions.map(r => ({name: r.name, data: r.data})),
                            colors: barData.regions.map(r => regionColors[r.code] || '#775DD0'),
                            yaxis: {max: barData.max_number}
                        });
                    } else {
                        console.warn("Ù†Ù…ÙˆØ¯Ø§Ø± Apex Ù‡Ù†ÙˆØ² Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡ - Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…");
                        buildBarChart(barData);
                    }
                }

                // ØªØ§Ø¨Ø¹ Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ø®Ø·ÛŒ Chart.js
                function updateLineCharts(lineData) {
                    const days = lineData.days;
                    // main chart
                    if (charts.mainChart) {
                        charts.mainChart.data.labels = days;
                        charts.mainChart.data.datasets[0].data = lineData.pure.this;
                        charts.mainChart.data.datasets[1].data = lineData.pure.last;
                        charts.mainChart.update();
                    }
                    // Ø³Ù‡ Ù†Ù…ÙˆØ¯Ø§Ø± Ú©ÙˆÚ†Ú©
                    const smallMap = {
                        efficiencyChart: 'eff',
                        availabilityChart: 'ava',
                        confidenceChart: 'conf'
                    };
                    Object.keys(smallMap).forEach(id => {
                        const chart = charts[id];
                        const key = smallMap[id];
                        if (chart) {
                            chart.data.labels = days;
                            chart.data.datasets[0].data = lineData[key].this;
                            chart.data.datasets[1].data = lineData[key].last;
                            chart.update();
                        }
                    });
                    // Ø¢Ù¾Ø¯ÛŒØª legendÙ‡Ø§ (Ø³Ø§Ù„ Ø¬Ø§Ø±ÛŒ Ùˆ Ù¾Ø§Ø±Ø³Ø§Ù„)
                    buildLegend("mainChart", lineData.last_year, lineData.year);
                    buildLegend("efficiencyChart", lineData.last_year, lineData.year);
                    buildLegend("availabilityChart", lineData.last_year, lineData.year);
                    buildLegend("confidenceChart", lineData.last_year, lineData.year);
                }

                document.getElementById('btnSearch').addEventListener('click', async function () {
                    const dateInput = document.querySelector('.top-filter-date').value.trim();
                    if (!dateInput || !/^\d{4}\/\d{2}\/\d{2}$/.test(dateInput)) {
                        showAlert('ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø±', 'ÙØ±Ù…Øª: Û±Û´Û°Û´/Û°Ûµ/Û²Û²', 'warning');
                        return;
                    }
                    Swal.fire({
                        title: 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                    try {
                        const url = `/get-dashboard-data/?date=${encodeURIComponent(dateInput)}`;
                        console.log("Ø¯Ø±Ø®ÙˆØ§Ø³Øª:", url);
                        const response = await fetch(url);
                        console.log("ÙˆØ¶Ø¹ÛŒØª:", response.status);
                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(`Ø³Ø±ÙˆØ±: ${response.status} â†’ ${text.slice(0, 200)}`);
                        }
                        const data = await response.json();
                        console.log("Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ:", data);
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        document.getElementById('stat-puretonkilo').innerHTML =
                            `ØªÙ† Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ø®Ø§Ù„Øµ<br>${Math.round(data.cards.puretonkilo).toLocaleString('fa-IR')}`;
                        document.getElementById('stat-loadedtonkilo').innerHTML =
                            `ØªÙ† Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ø¨Ø§Ø±Ø¯Ø§Ø±<br>${Math.round(data.cards.loadedtonkilo).toLocaleString('fa-IR')}`;
                        document.getElementById('stat-confidence').innerHTML =
                            `Ø¶Ø±ÛŒØ¨ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†<br>%${Math.round(data.cards.confidence_factor)}`;
                        document.getElementById('stat-availability').innerHTML =
                            `Ø¢Ù…Ø§Ø¯Ù‡â€ŒÚ©Ø§Ø±ÛŒ<br>%${Math.round(data.cards.availability)}`;
                        document.getElementById('stat-efficiency').innerHTML =
                            `Ø¨Ù‡Ø±Ù‡ ÙˆØ±ÛŒ<br>${Math.round(data.cards.efficiency).toLocaleString('fa-IR')}`;
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ØªÙ† Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ù¾Ø§ÛŒÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ø§ØµÙ„ÛŒ
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        document.getElementById('avg-last-year-tonkilo').textContent =
                            Math.round(data.averages.last_avg_tonkilo).toLocaleString('fa-IR');
                        document.getElementById('avg-this-year-tonkilo').textContent =
                            Math.round(data.averages.current_avg_tonkilo).toLocaleString('fa-IR');
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ± Ú©ÙˆÚ†Ú© Ù¾Ø§ÛŒÛŒÙ† Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        document.getElementById('eff-last-year').textContent = Math.round(data.averages.eff_last_year);
                        document.getElementById('eff-this-month').textContent = Math.round(data.averages.eff_this_month);
                        document.getElementById('ava-last-year').textContent = Math.round(data.averages.avail_last_year);
                        document.getElementById('ava-this-month').textContent = Math.round(data.averages.avail_this_month);
                        document.getElementById('conf-last-year').textContent = Math.round(data.averages.conf_last_year);
                        document.getElementById('conf-this-month').textContent = Math.round(data.averages.conf_this_month);
                        // Ø¢Ù¾Ø¯ÛŒØª Ø¹Ù†ÙˆØ§Ù†
                        document.querySelector('.top-filter-title').textContent = data.selected_date;
                        // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§
                        if (data.bar) updateBarChart(data.bar);
                        if (data.line) updateLineCharts(data.line);
                        Swal.close();
                        showAlert('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯', `Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ${data.selected_date} Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯`, 'success', 2200);
                    } catch (err) {
                        Swal.close();
                        console.error("Ø®Ø·Ø§:", err);
                        showAlert('Ø®Ø·Ø§', `Ø¬Ø²Ø¦ÛŒØ§Øª: ${err.message}<br>Ú©Ù†Ø³ÙˆÙ„ Ø±Ùˆ Ú†Ú© Ú©Ù†`, 'error', 0);
                    }
                });

                document.getElementById('btnLastUpdate').addEventListener('click', function () {
                    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯ÛŒØ±ÙˆØ² Ø¨Ù‡ ÙØ±Ù…Øª Ø´Ù…Ø³ÛŒ (1404/11/25 Ù…Ø«Ù„Ø§Ù‹)
                    const today = new Date();
                    today.setDate(today.getDate() - 1); // ÛŒÚ© Ø±ÙˆØ² Ù‚Ø¨Ù„
                    const yesterday = today.toLocaleDateString('fa-IR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    }).replace(/[/]/g, '/'); // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Û±Û´Û°Û´/Û±Û±/Û²Ûµ

                    // Ø¢Ù¾Ø¯ÛŒØª input ØªØ§Ø±ÛŒØ®
                    {#document.querySelector('.top-filter-date').value = yesterday;#}

                    // Ø¢Ù¾Ø¯ÛŒØª Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø§ÛŒ ÙÛŒÙ„ØªØ±
                    document.querySelector('.top-filter-title').textContent = yesterday;

                    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ú©ÙˆØªØ§Ù‡
                    showAlert('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', 'Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØ±ÙˆØ² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯...', 'info', 1500);

                    // Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Û±.Ûµ Ø«Ø§Ù†ÛŒÙ‡ (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ù¾ÛŒØ§Ù…)
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                });

                document.getElementById('btnExport').addEventListener('click', async function () {
                    Swal.fire({
                        title: 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´',
                        text: 'Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    try {
                        // Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³â€ŒØ¨Ø±Ø¯Ø§Ø±ÛŒ
                        const dashboardElement = document.getElementById('dashboardContainer');
                        if (!dashboardElement) throw new Error('Ø¨Ø®Ø´ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');

                        // Ú¯Ø±ÙØªÙ† Ø¹Ú©Ø³ Ø§Ø² Ú©Ù„ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                        const canvas = await html2canvas(dashboardElement, {
                            scale: 2,                // Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ØªØ±
                            useCORS: true,           // Ø§Ú¯Ø± ØªØµÙˆÛŒØ± Ø®Ø§Ø±Ø¬ÛŒ Ø¯Ø§Ø´Øª
                            backgroundColor: '#f8f9fa', // Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø±ÙˆØ´Ù†
                            logging: false
                        });

                        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ø¨Ù‡ Ø¹Ú©Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ - Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ ØªØ§Ø±ÛŒØ® Ø¯Ø§Ø®Ù„ Ø¹Ú©Ø³ Ø¨Ø§Ø´Ù‡)
                        const ctx = canvas.getContext('2d');
                        const currentDate = document.querySelector('.top-filter-title').textContent ||
                            new Date().toLocaleDateString('fa-IR', {
                                year: 'numeric', month: '2-digit', day: '2-digit'
                            });

                        ctx.font = 'bold 28px Vazir, Tahoma, sans-serif';
                        ctx.fillStyle = '#333';
                        ctx.textAlign = 'right';
                        ctx.fillText(`ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´: ${currentDate}`, canvas.width - 40, 60);

                        // ØªØ¨Ø¯ÛŒÙ„ canvas Ø¨Ù‡ ÙØ§ÛŒÙ„ PNG Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯
                        const link = document.createElement('a');
                        link.download = `Ú¯Ø²Ø§Ø±Ø´_Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯_${currentDate.replace(/\//g, '-')}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();

                        Swal.close();
                        showAlert('Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…ÙˆÙÙ‚', 'Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ú©Ø³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success', 2500);

                    } catch (err) {
                        Swal.close();
                        console.error('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´:', err);
                        showAlert('Ø®Ø·Ø§', `Ø³Ø§Ø®Øª Ú¯Ø²Ø§Ø±Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯<br>${err.message}`, 'error', 0);
                    }
                });
            });
    </script>
{% endblock javascripts %}







