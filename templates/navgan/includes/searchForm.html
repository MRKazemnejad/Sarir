<!-- contract/templates/contract/includes/searchForm.html -->
{% load search_extras %}
{% load static %}

<style>
    .search-toolbar {
        background: linear-gradient(180deg, rgba(225, 225, 245, 0.8) 0%, #fff 50%, rgba(225, 225, 245, 0.8) 100%);
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 10px 12px 8px;
        margin-bottom: 12px;
        direction: rtl;
        position: relative;
    {#overflow: hidden;#}
    }

    .search-toolbar .form-control, .search-toolbar .btn, .search-toolbar .dropdown-toggle {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
        height: 34px;
        margin-bottom: 0 !important;
    }

    .search-toolbar .dropdown-menu {
        min-width: 220px;
        font-size: 0.875rem;
        max-height: 300px;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .search-toolbar .checkbox-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .search-toolbar .checkbox-option input {
        margin: 0;
    }

    .search-toolbar .separator-line {
        height: 1px;
        background-color: #e0e0e0;
        margin: 10px 0 8px;
    }

    .search-toolbar .action-row {
        float: right;
        display: flex;
        gap: 8px;
    }

    .search-toolbar .action-row .btn {
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-size: 1rem;
        color: #495057;
        border: 1px solid #ced4da;
        background-color: #fff;
        transition: all 0.2s ease;
    }

    .search-toolbar .action-row .btn:hover {
        background-color: #f8f9fa;
        border-color: #adb5bd;
        color: #212529;
    }

    .extra-actions {
        display: flex;
        gap: 8px;
        margin-right: 10px;
        align-items: center;
    }

    .vertical-separator {
        width: 1px;
        height: 36px;
        background-color: #ced4da;
        margin: 0 8px;
        align-self: center;
    }

    .extra-actions .btn {
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-size: 1rem;
        color: #495057 !important;
        border: 1px solid #ced4da !important;
        background-color: #fff !important;
        transition: all 0.2s ease;
    }

    .extra-actions .btn:hover {
        background-color: #f8f9fa !important;
        border-color: #adb5bd !important;
        color: #212529 !important;
    }

    @media (max-width: 768px) {
        .search-toolbar .row > * {
            margin-bottom: 6px;
        }

        .search-toolbar .col-md-2 {
            flex: 0 0 50%;
            max-width: 50%;
        }

        .search-toolbar .action-row, .search-toolbar .extra-actions {
            float: none;
            justify-content: center;
            margin: 0 auto 8px;
        }
    }

    /* === آیکون‌های ریسپانسیو در دکمه‌های اکشن === */
    .search-toolbar .action-row .btn i, .search-toolbar .extra-actions .btn i {
        font-size: 1rem;
        transition: font-size 0.2s ease;
    }

    @media (max-width: 992px) {
        .search-toolbar .action-row .btn i, .search-toolbar .extra-actions .btn i {
            font-size: 0.95rem;
        }

        .search-toolbar .action-row .btn, .search-toolbar .extra-actions .btn {
            width: 34px;
            height: 34px;
        }
    }

    @media (max-width: 768px) {
        .search-toolbar .action-row .btn i, .search-toolbar .extra-actions .btn i {
            font-size: 0.9rem;
        }

        .search-toolbar .action-row .btn, .search-toolbar .extra-actions .btn {
            width: 32px;
            height: 32px;
        }
    }

    @media (max-width: 576px) {
        .search-toolbar .action-row .btn i, .search-toolbar .extra-actions .btn i {
            font-size: 0.85rem;
        }

        .search-toolbar .action-row .btn, .search-toolbar .extra-actions .btn {
            width: 30px;
            height: 30px;
        }
    }

    @media (max-width: 400px) {
        .search-toolbar .action-row .btn i, .search-toolbar .extra-actions .btn i {
            font-size: 0.8rem;
        }

        .search-toolbar .action-row .btn, .search-toolbar .extra-actions .btn {
            width: 28px;
            height: 28px;
        }
    }


    .permission-card {
        position: relative;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
    }

    .permission-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
    }

    .permission-checkbox {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 10;
        transform: scale(1.1);
    }

    /* dropdown background */
    .search-toolbar .dropdown-menu {
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }


    .legend-sm {
        font-size: 0.85rem !important;
    }

    .fieldset-gray {
        background-color: #f3f3f3; /* خاکستری روشن */
        border: 1px solid #d9d9d9;
        padding: 16px;
        border-radius: 8px;
    }

    .fieldset-gray legend {
        padding: 0 10px;
        font-weight: 700;
    }


    .insurance-file-item {
        width: 90px; /* عرض کلی باکس */
    }

    .preview-box {
        width: 3rem;
        height: 3rem;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-radius: 4px;
        border: 1px solid #dcdcdc;
    }

    .img-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .pdf-icon {
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
    }


</style>

<!-- Main menu -->
<div class="search-toolbar" data-tab="{{ tab_id }}" data-tab-id="{{ tab_id }}"
     data-model="{{ model_name|default:'invoice' }}">


    <form method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="template_name" value="{{ template_name }}">
        <input type="hidden" name="tab" value="{{ tab_id }}">
        <div class="row g-2 align-items-center">
            <div class="col-md-4 ">
                <input type="text" name="part" class="form-control form-control-sm" placeholder="موضوع"
                       value="{{ part|default:'' }}">
            </div>
            <div class="col-md-2 col-6">
                <input type="text" name="from_date" class="form-control form-control-sm " placeholder="از تاریخ"
                       data-jdp>
            </div>
            <div class="col-md-2 col-6">
                <input type="text" name="to_date" class="form-control form-control-sm " placeholder="تا تاریخ" data-jdp>
            </div>


            {% with status_choices=tab_id|get_status_choices %}
                {% if status_choices %}
                    <div class="col-md-2 col-6">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100 text-start"
                                    type="button" data-toggle="dropdown">
                                وضعیت <span class="selected-count"></span>
                            </button>
                            <ul class="dropdown-menu p-2" style="min-width: 220px;">
                                <!-- انتخاب همه -->
                                <li class="dropdown-item p-0 mb-2">
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="select_all_status_{{ tab_id }}"
                                               onclick="toggleAllStatus('{{ tab_id }}')">
                                        <label for="select_all_status_{{ tab_id }}" class="mb-0"><small>انتخاب
                                            همه</small></label>
                                    </div>
                                </li>
                                <li>
                                    <hr class="dropdown-divider my-1">
                                </li>

                                <!-- لیست وضعیت‌ها -->
                                {% for value, label in status_choices %}
                                    <li class="dropdown-item p-0">
                                        <div class="checkbox-option">
                                            <input type="checkbox"
                                                   name="status"
                                                   value="{{ value }}"
                                                   id="status_{{ value }}_{{ tab_id }}"
                                                   class="status-checkbox me-2"
                                                   {% if value in selected_statuses|default:'' %}checked{% endif %}>
                                            <label for="status_{{ value }}_{{ tab_id }}" class="mb-0">
                                                <small>{{ label }}</small>
                                            </label>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                {% endif %}
            {% endwith %}


            {#            <div class="col-md-2 col-6">#}
            {#                <div class="d-flex gap-2">#}
            {#                    <!-- جستجو — دقیقاً عین دکمه پرینت -->#}
            {#                    <button type="submit"#}
            {#                            class="btn btn-sm btn-outline-secondary p-2 lh-1"#}
            {#                            style="width: 36px; height: 36px;"#}
            {#                            title="جستجو">#}
            {#                        <i class="fas fa-search"></i>#}
            {#                    </button>#}
            {##}
            {#                    <!-- همه — دقیقاً عین دکمه رفرش و بقیه -->#}
            {#                    <button type="submit" formaction=""#}
            {#                            class="btn btn-sm btn-outline-secondary p-2 lh-1 mx-2"#}
            {#                            style="width: 36px; height: 36px;"#}
            {#                            title="نمایش همه">#}
            {#                        <i class="fas fa-redo-alt"></i>#}
            {#                    </button>#}
            {#                </div>#}
            {#            </div>#}

        </div>
        <div class="separator-line"></div>
        <div class="action-row">


            <!-- Print Button -->
            <button type="button" class="btn btn-sm btn-outline-dark print-btn" title="چاپ" data-action="print"
                    onclick="handleBulkAction(this)">
                <i class="fas fa-print"></i>
            </button>

            <!-- PDF Export Button -->
            <button type="button" class="btn btn-sm btn-outline-danger pdf-export" data-action="pdf-export"
                    title="خروجی PDF" onclick="handleBulkAction(this)">
                <i class="fas fa-file-pdf"></i>
            </button>

            <!-- Word Export Button -->
            <button type="button" class="btn btn-sm btn-outline-primary word-export" data-action="word-export"
                    title="خروجی Word"
                    onclick="handleBulkAction(this)">
                <i class="fas fa-file-word"></i>
            </button>

            <!-- Excel Export Button -->
            <button type="button" class="btn btn-sm btn-outline-success" title="اکسپورت به اکسل">
                <i class="fas fa-file-excel"></i>
            </button>


            <div class="vertical-separator"></div>
            <button type="button" class="btn btn-sm btn-outline-info" onclick="location.reload()" title="رفرش"><i
                    class="fas fa-sync-alt"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary advanced-filter" title="فیلتر پیشرفته"
                    data-action="advanced-filter"
                    onclick="handleBulkAction(this)"><i class="fas fa-filter"></i></button>

            <button type="button" class="btn btn-sm btn-outline-secondary" title="تنظیمات نمایش"><i
                    class="fas fa-cog"></i></button>
        </div>
        <div class="extra-actions">
            <div class="vertical-separator"></div>
            <button type="button" class="btn btn-sm btn-outline-primary" title="انتخاب همه" data-action="select_all"
                    onclick="handleBulkAction(this)">
                <i class="fas fa-check-square"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-warning" title="آرشیو" data-action="archive"
                    data-url="{% if archive_url %}{% url archive_url %}{% else %}javascript:void(0){% endif %}"
                    data-model="{{ model_name|default:'' }}" data-tab="{{ tab_id }}"
                    data-template="{{ template_name|default:'' }}" onclick="handleBulkAction(this)">
                <i class="fas fa-archive"></i>
            </button>
            {% if tab_id == "pills-current" or tab_id == "deductions" or tab_id == "appendix" or tab_id == "contracted" or tab_id == "contractNotified" or tab_id == "mycartable" or tab_id == 'registeredReceipts' %}
                <div class="vertical-separator"></div>
                <button type="button" class="btn btn-sm btn-outline-info" title="ویرایش" data-edit-type="{{ tab_id }}"
                        data-action="bulk_edit"
                        onclick="handleBulkAction(this)">
                    <i class="fas fa-edit"></i>
                </button>
            {% endif %}

            {% if tab_id == "appendix" %}
                <div class="vertical-separator"></div>
                <button type="button" class="btn btn-sm btn-outline-info" title="افزودن الحاقیه"
                        data-action="bulk_attachment"
                        onclick="handleBulkAction(this)">
                    <i class="fas fa-paperclip"></i>
                </button>
            {% endif %}


            {% if tab_id == "pills-current" or tab_id == "mycartable" or tab_id == 'registeredReceipts' %}
                <button type="button" class="btn btn-sm btn-outline-danger" title="حذف" data-action="bulk_delete"
                        data-model="{{ model_name|default:'' }}"
                        onclick="handleBulkAction(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            {% endif %}
        </div>
    </form>


    <!--General edit modal-->
    <div class="modal fade" id="editModal-{{ tab_id }}" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">ویرایش آیتم</h5>
                    <!-- تغییر: class="close" -->
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="editModalBody-{{ tab_id }}">
                    <div class="text-center py-5">
                        <div class="spinner-border text-info" style="width: 3rem; height: 3rem;"></div>
                        <p class="mt-3">در حال بارگذاری اطلاعات...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <!-- تغییر: data-dismiss -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">بستن</button>
                    <button type="button" class="btn btn-primary temp-save-btn" data-tab="{{ tab_id }}">ذخیره
                        تغییرات
                    </button>
                </div>
            </div>
        </div>
    </div>


</div>


<!-- Print Options Modal -->
<div class="modal fade" id="printOptionsModal" tabindex="-1" aria-labelledby="printOptionsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="printOptionsModalLabel">
                    <i class="fas fa-print"></i> انتخاب آیتم‌های چاپ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="print_invoice_code" value="">

                <div class="alert alert-info small">
                    <strong>کد فاکتور:</strong> <span id="print_invoice_display"></span>
                </div>

                <div class="form-check mb-3">
                    <input class="" type="checkbox" id="selectAllPrint">
                    <label class="form-check-label fw-bold text-primary" for="selectAllPrint">
                        انتخاب همه
                    </label>
                </div>

                <hr>

                <!-- آیتم‌های تب اول: فقط مجوز -->
                <div id="printItemsWaiting">
                    <div class="form-check mb-2">
                        <input class="print-item" type="checkbox" value="license_pdf"
                               id="print_license_pdf" checked>
                        <label class="form-check-label" for="print_license_pdf">
                            <i class="fas fa-file-pdf text-danger"></i> فرم مجوز (PDF)
                        </label>
                    </div>
                </div>

                <div id="invoiceCoverPrint">
                    <div class="form-check mb-2">
                        <input class="print-item" type="checkbox" value="invoice_cover"
                               id="invoice_cover_print" checked>
                        <label class="form-check-label" for="invoice_cover_print">
                            <i class="fas fa-file-pdf text-danger"></i>روکش فاکتور
                        </label>
                    </div>
                </div>


                <!-- آیتم‌های تب دوم: قرارداد + مدارک -->
                <div id="printItemsContracted" style="display: none;">
                    <div class="form-check mb-2">
                        <input class="form-check-input print-item" type="checkbox" value="contract_pdf"
                               id="print_contract_pdf">
                        <label class="form-check-label" for="print_contract_pdf">
                            <i class="fas fa-file-contract"></i> قرارداد
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input print-item" type="checkbox" value="commission_imgs"
                               id="print_commission">
                        <label class="form-check-label" for="print_commission">
                            <i class="fas fa-users"></i> مصوبه کمیسیون معاملات
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input print-item" type="checkbox" value="approval_imgs"
                               id="print_approval">
                        <label class="form-check-label" for="print_approval">
                            <i class="fas fa-gavel"></i> مصوبه هیئت مدیره
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input print-item" type="checkbox" value="contract_imgs"
                               id="print_contract_imgs">
                        <label class="form-check-label" for="print_contract_imgs">
                            <i class="fas fa-file-image"></i> تصاویر قرارداد
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input print-item" type="checkbox" value="check_imgs" id="print_check">
                        <label class="form-check-label" for="print_check">
                            <i class="fas fa-money-check"></i> تصویر چک تضمین
                        </label>
                    </div>

                </div>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">لغو</button>
                <button type="button" class="btn btn-success" id="startPrinting">
                    <i class="fas fa-print"></i> شروع چاپ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding Appendix -->
<div class="modal fade account" id="addAppendixModal" tabindex="-1" role="dialog"
     aria-labelledby="addAppendixModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content border-0 shadow-lg">
            <!-- Modal Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title font-weight-bold" id="addAppendixModalLabel">
                    <i class="fas fa-paperclip me-2"></i> افزودن الحاقیه قرارداد
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body p-4">
                <form id="addAppendixForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row justify-content-center">
                        <div class="col-12">

                            <!-- نوع الحاقیه -->
                            <fieldset class="mb-4 p-4 border rounded bg-light">
                                <legend class="w-auto px-3 fw-bold text-primary legend-sm">نوع الحاقیه</legend>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="custom-control custom-radio radio-container mb-3">
                                            <input type="radio" class="custom-control-input" id="commissionCheck"
                                                   name="appendix_type" value="TEMPORAL_EXTENSION" required checked>
                                            <label class="custom-control-label" for="commissionCheck">تمدید
                                                زمانی</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-control custom-radio radio-container mb-3">
                                            <input type="radio" class="custom-control-input" id="incrementCheck"
                                                   name="appendix_type" value="FINANCIAL_ADJUSTMENT">
                                            <label class="custom-control-label" for="incrementCheck">کاهش/افزایش
                                                ریالی</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-control custom-radio radio-container mb-3">
                                            <input type="radio" class="custom-control-input" id="endCheck"
                                                   name="appendix_type" value="TERMINATION">
                                            <label class="custom-control-label" for="endCheck">فسخ/خاتمه</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-control custom-radio radio-container mb-3">
                                            <input type="radio" class="custom-control-input" id="additionalCheck"
                                                   name="appendix_type" value="SUPPLEMENT">
                                            <label class="custom-control-label" for="additionalCheck">متمم</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-control custom-radio radio-container mb-3">
                                            <input type="radio" class="custom-control-input" id="editCheck"
                                                   name="appendix_type" value="AMENDMENT">
                                            <label class="custom-control-label" for="editCheck">اصلاحیه</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-control custom-radio radio-container mb-3">
                                            <input type="radio" class="custom-control-input" id="technicalCheck"
                                                   name="appendix_type" value="TECHNICAL">
                                            <label class="custom-control-label" for="technicalCheck">اصلاح فنی/فهرست
                                                بها</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="custom-control custom-radio radio-container mb-3">
                                            <input type="radio" class="custom-control-input" id="etcCheck"
                                                   name="appendix_type" value="ETC">
                                            <label class="custom-control-label" for="etcCheck">سایر</label>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- اطلاعات پایه -->
                            <fieldset class="mb-4 p-4 border rounded bg-light">
                                <legend class="w-auto px-3 fw-bold text-primary legend-sm">اطلاعات پایه</legend>
                                <input type="hidden" id="invoice_code" name="invoice_code">
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <div class="form-group">
                                            <label class="fw-bold">عنوان قرارداد <span
                                                    class="text-danger">*</span></label>

                                            <select class="form-control" id="contract_title" name="contract_title"
                                                    onchange="onContractSelected(this)" required>

                                            </select>

                                        </div>
                                        <div class="form-group mt-3">
                                            <label class="fw-bold">پیمانکار/فروشنده</label>
                                            <select class="form-control" id="contractor" name="contractor">
                                                <option value="0">انتخاب پیمانکار</option>
                                            </select>
                                        </div>
                                        <div class="form-group mt-3">
                                            <label class="fw-bold">عنوان پروژه</label>
                                            <select class="form-control" id="project_name" name="project_name">
                                                <option value="0">انتخاب پروژه</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="fw-bold">شماره قرارداد</label>
                                            <input type="text" id="contract_code" name="contract_code"
                                                   class="form-control" placeholder="شماره قرارداد ...">
                                        </div>
                                        <div class="form-group mt-3">
                                            <label class="fw-bold">تاریخ شروع</label>
                                            <input type="text" id="contract_startdate" name="contract_startdate"
                                                   class="form-control" placeholder="تاریخ شروع ..." data-jdp>
                                        </div>
                                        <div class="form-group mt-3">
                                            <label class="fw-bold">تاریخ قرارداد</label>
                                            <input type="text" id="contract_rundate" name="contract_rundate"
                                                   class="form-control" placeholder="تاریخ قرارداد ..." data-jdp>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="fw-bold">نوع قرارداد</label>
                                            <select class="form-control" id="contract_type" name="contract_type">
                                                <option value="1">لوازم اداری</option>
                                                <option value="2">خرید</option>
                                                <option value="3">فروش</option>
                                                <option value="4">برون سپاری</option>
                                                <option value="5">سایر</option>
                                            </select>
                                        </div>
                                        <div class="form-group mt-3">
                                            <label class="fw-bold">تاریخ پایان</label>
                                            <input type="text" id="contract_enddate" name="contract_enddate"
                                                   class="form-control" placeholder="تاریخ پایان ..." data-jdp>
                                        </div>
                                        <div class="form-group mt-3">
                                            <label class="fw-bold">گارانتی (روز)</label>
                                            <input type="number" id="warranty" name="warranty" class="form-control"
                                                   min="1" max="1825" placeholder="گارانتی ...">
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- اطلاعات مالی -->
                            <fieldset class="mb-4 p-4 border rounded bg-light">
                                <legend class="w-auto px-3 fw-bold text-primary legend-sm">اطلاعات مالی</legend>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="fw-bold">مبلغ قرارداد (ریال)</label>
                                        <input type="text" id="contract_price" name="contract_price"
                                               class="form-control" placeholder="ارزش قرارداد به ریال وارد گردد.">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="fw-bold">مبلغ قرارداد (دلار)</label>
                                        <input type="text" id="contract_price_dollar" name="contract_price_dollar"
                                               class="form-control" placeholder="مبلغ قرارداد به دلار وارد گردد. $">
                                        <small class="text-muted">* درصورت ثبت دلاری قرارداد</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="fw-bold">تاریخ نرخ دلار</label>
                                        <input type="text" id="dollar_date" name="dollar_date" class="form-control"
                                               placeholder="تاریخ را وارد نمایید." data-jdp>
                                        <small class="text-muted">* تاریخ ثبت قیمت دلاری</small>
                                    </div>
                                </div>

                                <div class="row my-4 align-items-center">
                                    <div class="col-md-4">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="prepayment_check"
                                                   name="prepayment_check" value="True">
                                            <label class="custom-control-label fw-bold" for="prepayment_check">پیش
                                                پرداخت دارد</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text">%</span>
                                            </div>
                                            <input type="number" class="form-control" id="prepayment_percentage"
                                                   name="prepayment_percentage" min="1" max="100" value="5" disabled>
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" id="prepayment_amount" name="prepayment_amount"
                                               class="form-control" placeholder="مبلغ پیش پرداخت (ریال)" disabled>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- تضامین و کسورات -->
                            <fieldset class="mb-4 p-4 border rounded bg-light">
                                <legend class="w-auto px-3 fw-bold text-primary legend-sm">تضامین و کسورات</legend>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="has_guarantee"
                                                   name="has_guarantee" value="True">
                                            <label class="custom-control-label fw-bold" for="has_guarantee">سپرده حسن
                                                انجام کار</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text">%</span>
                                            </div>
                                            <input type="number" class="form-control" id="guarantee_percentage"
                                                   name="guarantee_percentage" min="1" max="100" value="5" disabled>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="has_assurance"
                                                   name="has_assurance" value="True">
                                            <label class="custom-control-label fw-bold" for="has_assurance">تضمین انجام
                                                تعهدات</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text">%</span>
                                            </div>
                                            <input type="number" class="form-control" id="assurance_percentage"
                                                   name="assurance_percentage" min="1" max="100" value="5" disabled>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="has_withholding"
                                                   name="has_withholding" value="True">
                                            <label class="custom-control-label fw-bold" for="has_withholding">کسورات
                                                بیمه</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text">%</span>
                                            </div>
                                            <input type="number" class="form-control" id="withholding_percentage"
                                                   name="withholding_percentage" min="1" max="100" value="5" disabled>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- اسناد قرارداد -->
                            <fieldset class="mb-4 p-4 border rounded bg-light">
                                <legend class="w-auto px-3 fw-bold text-primary legend-sm">اسناد الحاقیه</legend>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="attachlicense"
                                                   name="attachlicense" value="True">
                                            <label class="custom-control-label fw-bold" for="attachlicense">مجوز</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" id="attachlicense_code" name="attachlicense_code"
                                               class="form-control" placeholder="کد مجوز" disabled>
                                    </div>
                                    <div class="col-md-5">
                                        <input type="file" id="attachlicense_file" name="attachlicense_file"
                                               class="form-control" multiple disabled>
                                    </div>
                                </div>
                                <div class="row g-3 mt-3">
                                    <div class="col-md-4">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="attach"
                                                   name="attach" value="True">
                                            <label class="custom-control-label fw-bold" for="attach">فایل
                                                الحاقیه</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" id="attach_code" name="attach_code" class="form-control"
                                               placeholder="کد الحاقیه" disabled>
                                    </div>
                                    <div class="col-md-5">
                                        <input type="file" id="attach_file" name="attach_file" class="form-control"
                                               multiple disabled>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- توضیحات -->
                            <fieldset class="mb-4 p-4 border rounded bg-light">
                                <legend class="w-auto px-3 fw-bold text-secondary legend-sm">توضیحات</legend>
                                <textarea class="form-control" id="contract_description" name="contract_description"
                                          rows="4" placeholder="توضیحات تکمیلی الحاقیه..."></textarea>
                            </fieldset>

                        </div>
                    </div>
                </form>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer bg-light border-top">
                <button type="button" class="btn btn-primary px-5" id="submitAppendix">
                    <i class="fas fa-save me-2"></i> ذخیره اطلاعات
                </button>
                <button type="button" class="btn btn-secondary px-4" data-dismiss="modal">
                    بستن
                </button>
            </div>
        </div>
    </div>
</div>


<!--Advanced filter -->
<div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">جستجوی پیشرفته</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="بستن">
                    <span aria-hidden="true">×</span>
                </button>
            </div>

            <form id="advancedSearchForm">
                <div class="modal-body">
                    <div class="row">

                        <!-- تاریخ از - تا -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateFrom">از تاریخ</label>
                                <input type="text" class="form-control " id="dateFrom" name="dateFrom"
                                       autocomplete="off" placeholder="انتخاب تاریخ" data-jdp>
                            </div>
                        </div>

                        <!-- تاریخ تا - فارسی -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateTo">تا تاریخ</label>
                                <input type="text" class="form-control" id="dateTo" name="dateTo" autocomplete="off"
                                       placeholder="انتخاب تاریخ" data-jdp>
                            </div>
                        </div>


                        <!-- موضوع -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="subject">موضوع</label>
                                <input type="text" class="form-control" id="subject" name="subject"
                                       placeholder="موضوع قرارداد">
                            </div>
                        </div>

                        <!-- شماره قرارداد -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="contractNumber">شماره قرارداد</label>
                                <input type="text" class="form-control" id="contractNumber" name="contractNumber"
                                       placeholder="شماره قرارداد">
                            </div>
                        </div>

                        <!-- پروژه -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="project">پروژه</label>
                                <select class="form-control" id="project" name="project">
                                    <option value="">انتخاب کنید...</option>
                                    <option value="proj1">پروژه الف</option>
                                    <option value="proj2">پروژه ب</option>
                                    <!-- گزینه‌های واقعی را اینجا اضافه کنید -->
                                </select>
                            </div>
                        </div>

                        <!-- مرکز هزینه -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="costCenter">مرکز هزینه</label>
                                <input type="text" class="form-control" id="costCenter" name="costCenter"
                                       placeholder="کد یا نام مرکز هزینه">
                            </div>
                        </div>

                        <!-- پیمانکار -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="contractor">پیمانکار</label>
                                <input type="text" class="form-control" id="contractor" name="contractor"
                                       placeholder="نام پیمانکار">
                            </div>
                        </div>

                        <!-- مبلغ قرارداد -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="contractAmount">مبلغ قرارداد (ریال)</label>
                                <input type="number" class="form-control" id="contractAmount" name="contractAmount"
                                       placeholder="مبلغ دقیق یا تقریبی">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">انصراف</button>
                    <button type="reset" class="btn btn-outline-warning">پاک کردن فیلترها</button>
                    <button type="submit" class="btn btn-primary">اعمال فیلتر</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Action buttons-->
<script>


    if (!window.bulkActionHandler) {
        window.bulkActionHandler = true;

        // ===================================================================
        //  Bulk Actions Handler + Card Detail Modal (All in One - No Conflicts)
        //  - Select All / Archive / Delete: Only targets .permission-checkbox in cards
        //  - Card Click: Open detail modal (NO checkbox toggle)
        //  - Checkbox Click: Only toggle (NO modal)
        //  - 100% Fixed with stopImmediatePropagation + pointer-events
        // ===================================================================

        window.handleBulkAction = function (btn) {
            const action = btn.dataset.action;
            const toolbar = btn.closest('.search-toolbar');
            const tabPane = toolbar?.closest('.tab-pane');
            const container = tabPane || document;
            const currentTabId = container.id || '';
            const isArchiveTab = currentTabId === 'pills-contact' || currentTabId.includes('archive') || currentTabId.includes('contact');

            // Update archive button icon/title
            const archiveBtn = toolbar.querySelector('[data-action="archive"]');
            if (archiveBtn) {
                const icon = archiveBtn.querySelector('i');
                const title = archiveBtn.getAttribute('title');
                if (isArchiveTab && title === 'آرشیو') {
                    icon.classList.replace('fa-archive', 'fa-box-open');
                    archiveBtn.setAttribute('title', 'لغو آرشیو');
                    archiveBtn.classList.replace('btn-outline-warning', 'btn-outline-success');
                } else if (!isArchiveTab && title === 'لغو آرشیو') {
                    icon.classList.replace('fa-box-open', 'fa-archive');
                    archiveBtn.setAttribute('title', 'آرشیو');
                    archiveBtn.classList.replace('btn-outline-success', 'btn-outline-warning');
                }
            }

            // Fixed: Only card checkboxes (ignore dropdown status checkboxes)
            const checkboxes = container.querySelectorAll('.permission-checkbox');

            if (action === 'select_all') {
                if (checkboxes.length === 0) {
                    Swal.fire('هشدار', 'هیچ موردی در این تب وجود ندارد.', 'warning');
                    return;
                }
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
                Swal.fire('موفقیت', `${checkboxes.length} مورد ${allChecked ? 'از انتخاب خارج' : 'انتخاب'} شد.`, 'success');
            } else if (action === 'archive' || action === 'bulk_delete') {
                const checked = container.querySelectorAll('.permission-checkbox:checked');
                if (checked.length === 0) {
                    Swal.fire('هشدار', 'لطفاً حداقل یک مورد را انتخاب کنید.', 'warning');
                    return;
                }


                const items = [];
                checked.forEach(cb => {
                    const card = cb.closest('[data-id]');
                    if (card?.dataset?.id) {
                        items.push({
                            id: card.dataset.id,
                            element: card.closest('.card, .permission-item, tr, li') || card
                        });
                    }
                });

                if (items.length === 0) {
                    Swal.fire('خطا', 'شناسه یافت نشد.', 'error');
                    return;
                }

                const isUnarchive = action === 'archive' && isArchiveTab;
                const title = isUnarchive ? 'لغو آرشیو' : (action === 'archive' ? 'آرشیو' : 'حذف دائم');
                const url = action === 'archive'
                    ? (btn.dataset.url || "{% url 'contract:contractInvoiceArchived' %}")
                    : "{% url 'contract:bulk_delete' %}";
                const templateName = btn.dataset.template || '';

                const toolbar = btn.closest('.search-toolbar');
                const ajaxTabId = toolbar?.dataset.tab;


                Swal.fire({
                    title,
                    text: `${items.length} مورد ${title} شود؟`,
                    icon: action === 'bulk_delete' ? 'warning' : 'question',
                    showCancelButton: true,
                    confirmButtonText: `بله، ${title} کن`,
                    confirmButtonColor: action === 'bulk_delete' ? '#dc3545' : (isUnarchive ? '#28a745' : '#f0ad4e')
                }).then(result => {
                    if (!result.isConfirmed) return;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            ids: items.map(i => i.id),
                            model: btn.dataset.model || 'invoice',
                            unarchive: isUnarchive,
                            template_name: templateName,
                            tabId: ajaxTabId,
                        })
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {

                                items.forEach(item => {
                                    if (item.element) {
                                        item.element.style.transition = 'all 0.5s ease';
                                        item.element.style.opacity = '0';
                                        item.element.style.transform = 'scale(0.95)';
                                        setTimeout(() => item.element.remove(), 500);
                                    }
                                });
                                Swal.fire('انجام شد!', data.message || `${items.length} مورد ${title} شد.`, 'success');
                                if (items.length >= checkboxes.length - 2) {
                                    setTimeout(() => location.reload(), 1000);
                                }
                            } else {
                                Swal.fire('خطا', data.message || 'عملیات ناموفق', 'error');
                            }
                        })
                        .catch(() => Swal.fire('خطا', 'ارتباط با سرور قطع شد.', 'error'));
                });
            } else if (action === 'bulk_edit') {
                const toolbar = btn.closest('.search-toolbar');
                const tabId = toolbar.dataset.tab;
                const container = toolbar.closest('.tab-pane') || document;

                // چک کن فقط یک مورد انتخاب شده باشه
                const checked = container.querySelectorAll('.permission-checkbox:checked');
                if (checked.length !== 1) {
                    Swal.fire('هشدار', 'لطفاً دقیقاً یک مورد را انتخاب کنید.', 'warning');
                    return;
                }


                if (tabId == 'pills-current') {

                    const checkbox = checked[0];
                    const card = checkbox.closest('.permission-card');
                    const invoiceId = parseInt(card.dataset.id);


                    if (isNaN(invoiceId)) {
                        Swal.fire('خطا', 'شناسه نامعتبر.', 'error');
                        return;
                    }


                    const modalId = `#editModal-${tabId}`;
                    const bodyId = `#editModalBody-${tabId}`;
                    const modalBody = $(bodyId)[0]; // برای populateEditModal

                    // اول مودال باز بشه
                    $(modalId).modal('show');

                    // لودینگ
                    $(bodyId).html(`
                        <div class="text-center py-5">
                            <div class="spinner-border text-info" style="width: 3rem; height: 3rem;"></div>
                            <p class="mt-3">در حال بارگذاری اطلاعات فاکتور ${invoiceId}...</p>
                        </div>
                    `);

                    // AJAX
                    const url = `/contractDashboard/invoice-edit-ajax/${invoiceId}/`;
                    console.log('AJAX URL:', url);

                    $.ajax({
                        url: url,
                        type: 'GET',
                        dataType: 'json',
                        headers: {
                            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function (data) {
                            console.log('AJAX Success:', data);
                            if (data.success) {
                                setTimeout(() => {
                                    try {
                                        populateEditModal(data.data, invoiceId, tabId); // tabId اضافه شد
                                        console.log('Populate completed');
                                    } catch (err) {
                                        console.error('Populate Error:', err);
                                        $(bodyId).html(`<div class="alert alert-danger">خطا در رندر: ${err.message}</div>`);
                                    }
                                }, 100);
                            } else {
                                $(bodyId).html(`<div class="alert alert-danger">خطا: ${data.message || 'نامشخص'}</div>`);
                            }
                        },
                        error: function (xhr) {
                            console.error('AJAX Error:', xhr);
                            let msg = 'ارتباط با سرور قطع شد.';
                            if (xhr.status === 404) msg = 'آدرس یافت نشد (urls.py)';
                            if (xhr.status === 500) msg = 'خطای سرور (لاگ Django)';
                            $(bodyId).html(`<div class="alert alert-danger">${msg}</div>`);
                        }
                    });
                } else if (tabId == 'deductions') {

                    const checkbox = checked[0];
                    const card = checkbox.closest('.deductions-edit');
                    if (!card) {
                        console.error('Card not found with .deductions-edit');
                        return Swal.fire('خطا', 'کارت کسورات پیدا نشد.', 'error');
                    }

                    const contractCode = card.dataset.contractCode;
                    if (!contractCode) {
                        return Swal.fire('خطا', 'کد قرارداد وجود ندارد.', 'error');
                    }


                    // باز کردن مودال
                    const modalId = '#editModal-deductions';
                    const bodyId = '#editModalBody-deductions';
                    $(modalId).modal({backdrop: false}).modal('show');

                    {#$(modalId).modal('show');#}
                    $(bodyId).html(`
                    <div class="text-center py-5">
                        <div class="spinner-border text-warning" style="width: 3rem; height: 3rem;"></div>
                        <p class="mt-3">در حال بارگذاری کسورات قرارداد ${contractCode}...</p>
                    </div>
                `);

                    // AJAX
                    const url = `/contractDashboard/deduction-edit-ajax/${contractCode}/`;
                    console.log('AJAX URL (Deductions):', url);

                    $.ajax({
                        url: url,
                        type: 'GET',
                        dataType: 'json',
                        headers: {
                            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function (data) {
                            console.log('AJAX Success (Deductions):', data);
                            if (data.success) {
                                setTimeout(() => {
                                    try {
                                        populateDeductionsModal(data.data, contractCode);
                                        console.log('Populate Deductions completed');
                                    } catch (err) {
                                        console.error('Populate Error:', err);
                                        $(bodyId).html(`<div class="alert alert-danger">خطا در رندر: ${err.message}</div>`);
                                    }
                                }, 100);
                            } else {
                                $(bodyId).html(`<div class="alert alert-danger">خطا: ${data.message || 'نامشخص'}</div>`);
                            }
                        },
                        error: function (xhr) {
                            console.error('AJAX Error:', xhr);
                            let msg = 'ارتباط با سرور قطع شد.';
                            if (xhr.status === 404) msg = 'آدرس یافت نشد (urls.py)';
                            if (xhr.status === 500) msg = 'خطای سرور';
                            $(bodyId).html(`<div class="alert alert-danger">${msg}</div>`);
                        }
                    });


                } else if (tabId == 'appendix') {


                    const checked = container.querySelectorAll('.permission-checkbox:checked');
                    if (checked.length !== 1) {
                        Swal.fire('هشدار', 'لطفاً دقیقاً یک الحاقیه را انتخاب کنید.', 'warning');
                        return;
                    }

                    const card = checked[0].closest('.permission-card');
                    const appendixCode = card.dataset.appendixCode;


                    const modal = $('#editModal-appendix');
                    const body = $('#editModalBody-appendix');


                    modal.modal({backdrop: false}).modal('show');
                    body.html('<div class="text-center py-5"><div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div><p class="mt-3">در حال بارگذاری...</p></div>');

                    $.ajax({
                        url: '/contractDashboard/appendix_edit_ajax/',
                        type: 'GET',
                        data: {code: appendixCode},
                        success: function (res) {
                            if (res.success) {
                                populateAppendixModal(res.data, appendixCode);
                            } else {
                                body.html(`<div class="alert alert-danger text-center">${res.error}</div>`);
                            }
                        },
                        error: () => body.html('<div class="alert alert-danger text-center">خطا در ارتباط با سرور</div>')
                    });


                } else if (tabId === 'contracted' || tabId === 'contractNotified') {
                    const checked = container.querySelectorAll('.permission-checkbox:checked');
                    if (checked.length !== 1) {
                        Swal.fire('هشدار', 'لطفاً دقیقاً یک قرارداد را انتخاب کنید.', 'warning');
                        return;
                    }

                    const checkbox = checked[0];
                    const card = checkbox.closest('.permission-card');
                    if (!card) {
                        Swal.fire('خطا', 'کارت قرارداد پیدا نشد.', 'error');
                        return;
                    }

                    const contractCode = card.dataset.contractCode || card.dataset.id; // بسته به اینکه کدوم رو استفاده کردی
                    if (!contractCode) {
                        Swal.fire('خطا', 'شماره قرارداد یافت نشد.', 'error');
                        return;
                    }

                    // باز کردن مودال ویرایش (فرض می‌کنیم مودالی با این آی‌دی داری)
                    const modalId = '#editModal-' + tabId;  // یا یه مودال مشترک مثل #editModal-contracted
                    const bodyId = '#editModalBody-' + tabId;

                    $(modalId).modal({backdrop: false}).modal('show');
                    $(bodyId).html(`
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                            <p class="mt-3">در حال بارگذاری اطلاعات قرارداد ${contractCode}...</p>
                        </div>
                    `);

                    // AJAX برای گرفتن اطلاعات قرارداد
                    $.ajax({
                        url: `/contractDashboard/contract-edit-ajax/${contractCode}/`,
                        type: 'GET',
                        dataType: 'json',
                        headers: {'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()},
                        success: function (data) {
                            if (data.success) {
                                // اینجا تابع populate رو فراخوانی کن (مثل deductions یا appendix)
                                populateContractEditModal(data.data, contractCode, tabId);
                            } else {
                                $(bodyId).html(`<div class="alert alert-danger">${data.message || 'خطا در بارگذاری اطلاعات'}</div>`);
                            }
                        },
                        error: function () {
                            $(bodyId).html('<div class="alert alert-danger">خطا در ارتباط با سرور</div>');
                        }
                    });

                } else if (tabId === 'mycartable') {

                    const checked = container.querySelectorAll('.permission-checkbox:checked');
                    if (checked.length !== 1) {
                        Swal.fire('هشدار', 'لطفاً دقیقاً یک مجوز موقت را انتخاب کنید.', 'warning');
                        return;
                    }
                    const checkbox = checked[0];
                    const card = checkbox.closest('.permission-card');
                    if (!card) {
                        Swal.fire('خطا', 'کارت مجوز موقت پیدا نشد.', 'error');
                        return;
                    }
                    const licenseCode = card.dataset.licenseCode || card.dataset.id;
                    if (!licenseCode) {
                        Swal.fire('خطا', 'شماره مجوز موقت یافت نشد.', 'error');
                        return;
                    }

                    const modalId = `#editModal-${tabId}`;
                    const bodyId = `#editModalBody-${tabId}`;

                    $(modalId).modal({backdrop: false}).modal('show');
                    $(bodyId).html(`
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                            <p class="mt-3">در حال بارگذاری اطلاعات قرارداد ${licenseCode}...</p>
                        </div>
                    `);

                    $.ajax({
                        url: `/contractDashboard/licensetemp-edit-ajax/${licenseCode}/`,
                        type: 'GET',
                        dataType: 'json',
                        headers: {
                            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function (data) {
                            if (data.success) {
                                setTimeout(() => {
                                    try {
                                        populateLicenseTempModal(data.data, licenseCode, tabId);
                                    } catch (err) {
                                        console.error('Populate Error:', err);
                                        $(bodyId).html(`<div class="alert alert-danger">خطا در نمایش فرم: ${err.message}</div>`);
                                    }
                                }, 100);
                            } else {
                                $(bodyId).html(`<div class="alert alert-danger">خطا: ${data.message || 'بارگذاری ناموفق'}</div>`);
                            }
                        },
                        error: function (xhr) {
                            console.error('AJAX Error:', xhr);
                            $(bodyId).html(`<div class="alert alert-danger">خطا در ارتباط با سرور</div>`);
                        }
                    });

                } else if (tabId == 'registeredReceipts') {

                }
            } else if (action == 'word-export') {
                const toolbar = btn.closest('.search-toolbar');
                const tabId = toolbar?.dataset.tab;

                const container = toolbar.closest('.tab-pane') || document;
                const checked = container.querySelectorAll('.permission-checkbox:checked');

                if (checked.length !== 1) {
                    Swal.fire('هشدار', 'لطفاً دقیقاً یک مورد را انتخاب کنید.', 'warning');
                    return;
                }

                const checkbox = checked[0];
                const card = checkbox.closest('.permission-card');
                const invoiceCode = card.dataset.contractCode || card.dataset.id;  // یا هر data- که استفاده کردی

                if (!invoiceCode) {
                    Swal.fire('خطا', 'شماره مجوز یافت نشد.', 'error');
                    return;
                }


                let url = '';
                if (tabId === 'contractWaiting' || tabId === 'currentPermissions' || tabId === 'mycartable' || tabId === 'approved' ||
                    tabId === 'licensecurrent' || tabId === 'licenserejected' || tabId === 'licensecompleted' || tabId === 'licensearchived') {
                    url = `/contractDashboard/contractLicenseWord/${encodeURIComponent(invoiceCode)}/`;
                } else if (tabId === 'contractedPermissions' || tabId === 'archivedPermissions') {
                    url = `/contractDashboard/contractWord/${encodeURIComponent(invoiceCode)}/`;
                } else if (tabId === 'mycovercartable' || tabId === 'coverApproved' || tabId === 'coverCurrent') {

                    url = `/contractDashboard/invoiceCoverWord/${encodeURIComponent(invoiceCode)}/`;
                } else {
                    Swal.fire('خطا', 'این عملیات برای این تب پشتیبانی نمی‌شود.', 'error');
                    return;
                }

                // open in new tab
                window.open(url, '_blank');


            } else if (action === 'pdf-export') {

                const toolbar = btn.closest('.search-toolbar');
                const tabId = toolbar?.dataset.tab || '';
                const container = toolbar.closest('.tab-pane') || document;

                const checked = container.querySelectorAll('.permission-checkbox:checked');

                if (checked.length !== 1) {
                    Swal.fire('هشدار', 'لطفاً دقیقاً یک مورد را انتخاب کنید.', 'warning');
                    return;
                }

                const checkbox = checked[0];
                const card = checkbox.closest('.permission-card');
                const invoiceCode = card.dataset.contractCode || card.dataset.id;

                if (!invoiceCode) {
                    Swal.fire('خطا', 'شماره مجوز یافت نشد.', 'error');
                    return;
                }

                // تعیین URL بر اساس تب
                let url = '';
                if (tabId === 'contractWaiting' || tabId === 'currentPermissions' || tabId === 'mycartable' || tabId === 'approved' ||
                    tabId === 'licensecurrent' || tabId === 'licenserejected' || tabId === 'licensecompleted' || tabId === 'licensearchived') {
                    url = `/contractDashboard/contractLicensePdf/${encodeURIComponent(invoiceCode)}/`;
                } else if (tabId === 'contractedPermissions' || tabId === 'archivedPermissions') {
                    url = `/contractDashboard/contractPdf/${encodeURIComponent(invoiceCode)}/`;  // بعداً این رو اضافه کن
                } else {
                    Swal.fire('خطا', 'این عملیات برای این تب پشتیبانی نمی‌شود.', 'error');
                    return;
                }

                // باز کردن PDF در تب جدید (بهترین تجربه)
                window.open(url, '_blank');

            } else if (action === 'print') {
                const toolbar = btn.closest('.search-toolbar');
                const tabId = toolbar?.dataset.tab;

                const container = toolbar.closest('.tab-pane') || document;

                const checked = container.querySelectorAll('.permission-checkbox:checked');

                if (checked.length !== 1) {
                    Swal.fire('هشدار', 'لطفاً دقیقاً یک مورد را انتخاب کنید.', 'warning');
                    return;
                }

                const card = checked[0].closest('.permission-card');
                const invoiceCode = card.dataset.contractCode || card.dataset.id;

                if (!invoiceCode) {
                    Swal.fire('خطا', 'شماره فاکتور یافت نشد.', 'error');
                    return;
                }

                // نمایش کد در مودال
                document.getElementById('print_invoice_code').value = invoiceCode;
                document.getElementById('print_invoice_display').textContent = invoiceCode;

                // نمایش آیتم‌های مناسب بر اساس تب
                if (tabId === 'contractWaiting' || tabId === 'currentPermissions') {
                    $('#printItemsWaiting').show();
                    $('#printItemsContracted').hide();
                    $('#print_license_pdf').prop('checked', true);
                } else if (tabId === 'contracted') {
                    $('#printItemsWaiting').show();
                    $('#printItemsContracted').hide();
                    $('#print_license_pdf').prop('checked', true);
                } else if (tabId === 'mycartable' || tabId === 'approved' || tabId === 'licensecurrent' || tabId === 'licenserejected' || tabId === 'licensecompleted' || tabId === 'licensearchived') {
                    $('#printItemsWaiting').show();
                    $('#printItemsContracted').hide();
                    $('#print_license_pdf').prop('checked', true);
                }
                //invoice cover print
                else if (tabId === 'mycovercartable') {

                    $('#printItemsWaiting').hide();
                    $('#printItemsContracted').show();

                } else {
                    $('#printItemsWaiting').hide();
                    $('#printItemsContracted').show();
                }

                // باز کردن مودال
                const printModal = document.getElementById('printOptionsModal');
                if (printModal) {
                    new bootstrap.Modal(printModal).show();
                }
            } else if (action === 'bulk_attachment') {
                // Get the current toolbar to determine which tab we're in
                const toolbar = btn.closest('.search-toolbar');
                const tabId = toolbar?.dataset.tab || '';

                // Optional safety check – only allow this action in the "appendix" tab
                if (tabId !== 'appendix') {
                    Swal.fire('Warning', 'این عملیات فقط در تب الحاقیه‌ها قابل انجام است.', 'warning');
                    return;
                }


                const modalId = document.getElementById('addAppendixModal');
                ;

                // Open the "Add Appendix" modal

                if (modalId) {
                    // Bootstrap 4 syntax (you're using jQuery modal)
                    $(modalId).modal({backdrop: false}).modal('show');

                    // Alternative for Bootstrap 5:
                    // new bootstrap.Modal(modal).show();

                    // === Reset the form completely for a fresh entry ===
                    const form = document.getElementById('addAppendixForm');
                    if (form) form.reset();

                    // Clear hidden invoice code field
                    const invoiceCodeField = document.getElementById('invoice_code');
                    if (invoiceCodeField) invoiceCodeField.value = '';

                    // Reset radio buttons to default (Temporal Extension)
                    const defaultRadio = document.getElementById('commissionCheck');
                    if (defaultRadio) defaultRadio.checked = true;

                    // Reset all checkboxes (prepayment, guarantees, etc.)
                    ['prepayment_check', 'has_guarantee', 'has_assurance', 'has_withholding'].forEach(id => {
                        const cb = document.getElementById(id);
                        if (cb) cb.checked = false;
                    });

                    // Disable dependent percentage/amount fields
                    ['prepayment_percentage', 'prepayment_amount',
                        'guarantee_percentage', 'assurance_percentage', 'withholding_percentage'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.disabled = true;
                    });

                    // Optional: show a small welcome toast
                    // Swal.fire('Add Appendix', 'Please fill in the details for the new appendix.', 'info');
                } else {
                    Swal.fire('Error', 'مودال یافت نشد', 'error');
                }
            }
        };

//****************************************************************************************************************

        function populateLicenseTempModal(data, invoiceCode, tabId = 'mycartable') {


            const modalBody = $(`#editModalBody-${tabId}`);
            if (!modalBody.length) return;

            modalBody.empty();

            const {records} = data;
            if (!records || records.length === 0) {
                modalBody.html('<div class="text-center py-5 text-muted">هیچ اطلاعاتی یافت نشد.</div>');
                return;
            }

            const mainRec = records[0];

            const unitsOptions = (mainRec.units_list || []).map(u =>
                `<option value="${u.unit_code}" ${mainRec.units.includes(u.unit_code) ? 'selected' : ''}>
                    ${u.unit_name} (${u.unit_code})
                </option>`
            ).join('');

            const statusSelect = Object.entries({
                'LICNOTFD': 'مجوز ابلاغ شده', 'LICCNTED': 'قرارداد شده', 'LICCNNTF': 'قرارداد ابلاغ شده',
                'LICCMPLT': 'مجوز تأیید شده', 'LICREJCT': 'رد شده', 'LICRTURNE': 'بازگشت به کارشناس خرید',
                'LICRTURNC': 'بازگشت به امور قرارداد', 'LICRTURNM': 'بازگشت به مدیر بازرگانی',
                'LICRTURND': 'بازگشت به قائم مقام', 'LICPURCH': 'در انتظار امضای کارشناس خرید',
                'LICCNTRC': 'در انتظار امضای امور قراردادها', 'LICMNGCM': 'در انتظار امضای مدیر بازرگانی',
                'LICDPUTY': 'در انتظار امضای قائم مقام', 'LICCEOAP': 'در انتظار امضای مدیر عامل',
                'LICBOARD': 'در انتظار امضای هیئت مدیره',
            }).map(([val, lbl]) =>
                `<option value="${val}" ${mainRec.status === val ? 'selected' : ''}>${lbl}</option>`
            ).join('');

            // ساخت تمام قطعات — هر license یک قطعه جدا
            let partsHtml = '';
            records.forEach((rec, partIdx) => {
                const part = rec.parts[0] || {};
                const companies = part.company_prices || {};
                const winner = part.winner || '';


                partsHtml += `
                    <div class="card shadow mb-4">
                       <input type="hidden" name="parts[${partIdx}][id]" value="${rec.id || ''}">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-white">قطعه ${partIdx + 1} — ${escapeHtml(part.part_name || 'بدون نام')}</h6>
                            <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.card').remove(); updateLicenseTable3()">
                                حذف این قطعه
                            </button>
                        </div>
                        <div class="card-body">

                            <!-- اطلاعات قطعه -->
                            <fieldset class="mb-1 p-3 border rounded bg-light">
                                <legend class="w-auto px-2 fw-bold legend-sm text-primary">اطلاعات قطعه</legend>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">نام قطعه</label>
                                        <input name="parts[${partIdx}][part_name]" class="form-control form-control-sm part-name" value="${escapeHtml(part.part_name || '')}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">پارت نامبر</label>
                                        <input name="parts[${partIdx}][part_number]" class="form-control form-control-sm" value="${escapeHtml(part.part_number || '')}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">تعداد</label>
                                        <input name="parts[${partIdx}][quantity]" type="number" class="form-control form-control-sm part-quantity" value="${part.quantity || 1}" min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">واحد</label>
                                        <input name="parts[${partIdx}][unit]" class="form-control form-control-sm part-unit" value="${escapeHtml(part.unit || '')}">
                                    </div>
                                </div>
                            </fieldset>

                            <!-- قیمت‌های شرکت‌ها + چک‌باکس برنده -->
                            <fieldset class="mb-1 p-3 border rounded bg-light">
                                <legend class="w-auto px-2 legend-sm text-primary">قیمت‌های پیشنهادی شرکت‌ها</legend>
                                <div class="row g-3">
                                  ${Object.entries(companies).map(([company, price], compIdx) => {
                    const companyId = part.company_prices_ids?.[company] || '';  // ← این خط جدید
                    const isWinner = (winner === company);
                    return `
                                          <div class="col-md-4 company-row mb-2">
                                            <div class="input-group input-group-sm">
                                              <!-- این hidden رو اضافه کن -->
                                              <input type="hidden" name="parts[${partIdx}][companies][${compIdx}][id]" value="${companyId}">

                                              <!-- چک‌باکس برنده -->
                                              <div class="input-group-text">
                                                <input type="checkbox"
                                                   name="parts[${partIdx}][companies][${compIdx}][is_winner]"
                                                   value="on"
                                                   class="winner-checkbox"
                                                   data-part-idx="${partIdx}"
                                                   data-comp-idx="${compIdx}"
                                                   ${isWinner ? 'checked' : ''}>
                                              </div>
                                              <!-- نام شرکت -->
                                              <input type="text" name="parts[${partIdx}][companies][${compIdx}][company]" class="form-control form-control-sm company-name-input" value="${escapeHtml(company)}" placeholder="نام شرکت">
                                              <!-- قیمت -->
                                              <input type="text" name="parts[${partIdx}][companies][${compIdx}][price]" class="form-control text-start winner-price" data-part-idx="${partIdx}" dir="ltr" value="${price}">
                                              <!-- دکمه حذف -->
                                              <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.company-row').remove(); updateLicenseTable3()"> حذف </button>
                                            </div>
                                          </div>
                                        `;
                }).join('')}
                                                                    </div>

                                    <div class="text-end mt-2">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-success"
                                                onclick="addNewCompany(${partIdx})">
                                            افزودن شرکت جدید
                                        </button>
                                    </div>
                            </fieldset>

                            <!-- سابقه خرید -->
                            <fieldset class="p-3 border rounded bg-light">
                                <legend class="w-auto px-2 fw-bold legend-sm text-primary">سابقه خرید</legend>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">شرکت سابقه</label>
                                        <input name="parts[${partIdx}][historic_company]" class="form-control form-control-sm" value="${escapeHtml(part.historic_company || '')}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">تاریخ</label>
                                        <input name="parts[${partIdx}][historic_date]" class="form-control form-control-sm" data-jdp value="${part.historic_date || ''}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">قیمت سابقه</label>
                                        <input name="parts[${partIdx}][historic_price]" class="form-control form-control-sm text-start" dir="ltr" value="${part.historic_price || ''}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">درصد تغییر</label>
                                        <input name="parts[${partIdx}][historic_change]" class="form-control form-control-sm text-danger fw-bold" value="${part.historic_change || ''}" readonly>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                `;
            });

            const html = `
                <form class="license-edit-form" data-invoice-code="${invoiceCode}">
                    <input type="hidden" name="invoice_code" value="${invoiceCode}">

                    <!-- اطلاعات اصلی مجوز -->
                    <fieldset class="mb-4 p-4 border rounded bg-light">
                        <legend class="w-auto px-3 fw-bold text-primary legend-sm">اطلاعات اصلی مجوز</legend>
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label fw-bold">شماره مجوز</label><input type="text" class="form-control" value="${invoiceCode}" disabled></div>
                            <div class="col-md-3"><label class="form-label fw-bold">موضوع</label><input name="subject" class="form-control" value="${escapeHtml(mainRec.subject || '')}"></div>
                            <div class="col-md-3"><label class="form-label fw-bold">نام پروژه</label><input name="project_name" class="form-control" value="${escapeHtml(mainRec.project_name || '')}"></div>
                            <div class="col-md-3"><label class="form-label fw-bold">تاریخ درخواست</label><input name="request_date" class="form-control" data-jdp value="${mainRec.request_date || ''}"></div>
                        </div>
                    </fieldset>

                    <!-- تمام قطعات -->
                    <div id="parts-container" class="mb-4">
                        ${partsHtml}
                    </div>
                    <div class="text-center mb-4">
                        <button type="button" class="btn btn-success btn-lg" onclick="addNewPart()"> افزودن قطعه جدید </button>
                    </div>

                    <!-- جدول مصوبات -->
                    <fieldset class="mb-4 p-4 border rounded bg-light">
                        <legend class="w-auto px-3 fw-bold text-primary d-flex justify-content-between align-items-center legend-sm">
                            <span>جدول مصوبات</span>
                        </legend>
                         <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th>ردیف</th>
                                        <th>شرح خدمات/کالا</th>
                                        <th>تعداد</th>
                                        <th>واحد</th>
                                        <th>شرکت برنده</th>
                                        <th>جمع کل به ریال</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="table3-body" class="text-center"></tbody>
                                <tfoot>
                                    <tr class="table-info">
                                        <td colspan="5" class="text-center fw-bold">جمع کل:</td>
                                        <td id="table3-total" class="fw-bold text-center" dir="ltr">0 ریال</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </fieldset>

                    <!-- وضعیت و واحدهای ابلاغ‌شده -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <fieldset class="p-4 border rounded bg-light">
                                <legend class="w-auto px-3 fw-bold text-primary legend-sm">وضعیت مجوز</legend>
                                <div class="col-md-6">
                                    <select name="status" class="form-control">${statusSelect}</select>
                                </div>
                            </fieldset>
                        </div>
                    </div>

                    <!-- فرم‌های تکمیل شده -->
                    <fieldset class="mb-4 p-4 border rounded bg-light">
                        <legend class="w-auto px-3 fw-bold text-primary legend-sm">فرم‌های تکمیل شده</legend>
                        <div class="row g-3">
                            ${['qc_form', 'compare_form', 'request_form', 'inquery_form', 'preinvoice_form', 'properties_form', 'pics_form'].map(f => {
                const labels = {
                    qc_form: 'فرم QC',
                    compare_form: 'فرم مقایسه',
                    request_form: 'فرم درخواست خرید',
                    inquery_form: 'فرم استعلام',
                    preinvoice_form: 'پیش‌فاکتور',
                    properties_form: 'مشخصات فنی',
                    pics_form: 'تصاویر و مدارک'
                };
                const checked = mainRec[f] ? 'checked' : '';
                return `<div class="col-md-4"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="${f}" ${checked}><label class="form-check-label">${labels[f]}</label></div></div>`;
            }).join('')}
                        </div>
                    </fieldset>


                </form>
            `;

            modalBody.html(html);

            if (window.jalaliDatepicker) {
                setTimeout(() => jalaliDatepicker.startWatch({selector: 'input[data-jdp]'}), 200);
            }

            window.currentLicenseData = data;
            updateLicenseTable3(); // اولین بار از سرور پر می‌شه

        }


        // افزودن شرکت جدید به یک قطعه
        function addNewCompany(partIdx) {
            const container = document.querySelectorAll('#parts-container .card')[partIdx]
                .querySelector('fieldset > .row.g-3');
            const compIdx = container.querySelectorAll('.company-row').length;
            const newRow = `
      <div class="col-md-4 company-row mb-2">
        <div class="input-group input-group-sm">
          <!-- برای شرکت جدید id خالیه -->
          <input type="hidden" name="parts[${partIdx}][companies][${compIdx}][id]" value="">

          <div class="input-group-text">
                <input type="checkbox"
           name="parts[${partIdx}][companies][${compIdx}][is_winner]"
           value="on"
           class="winner-checkbox"
           data-part-idx="${partIdx}"
           data-comp-idx="${compIdx}">
          </div>
          <input type="text" name="parts[${partIdx}][companies][${compIdx}][company]" class="form-control form-control-sm company-name-input" placeholder="نام شرکت جدید">
          <input type="text" name="parts[${partIdx}][companies][${compIdx}][price]" class="form-control text-start" dir="ltr" value="0" placeholder="قیمت">
          <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.company-row').remove(); updateLicenseTable3()"> حذف </button>
        </div>
      </div>
    `;
            container.insertAdjacentHTML('beforeend', newRow);
            updateLicenseTable3();
        }

        // فقط یک برنده در هر قطعه
        $(document).on('change', '.winner-checkbox', function () {
            if (this.checked) {
                const partIdx = this.dataset.partIdx;
                document.querySelectorAll(`.winner-checkbox[data-part-idx="${partIdx}"]`)
                    .forEach(cb => {
                        if (cb !== this) cb.checked = false;
                    });
            }
            updateLicenseTable3();
        });


        // تابع تبدیل عدد فارسی یا با کاما به عدد صحیح
        function toNumber(str) {
            if (!str) return 0;
            const cleaned = String(str).replace(/,/g, '').replace(/[^\d-]/g, '');
            return parseInt(cleaned, 10) || 0;
        }

        // تبدیل عدد به فارسی (برای نمایش)
        function toPersianNumber(num) {
            if (num === undefined || num === null || num === '') return '۰';
            return String(num).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
        }

        // فرار از کاراکترهای خاص در سلکتور
        function escapeForSelector(str) {
            return str.replace(/([ #;&,.+*~\':"!^$[\]()=>|/@])/g, '\\$1');
        }

        // تابع اصلی آپدیت جدول مصوبات
        function updateLicenseTable3() {
            const tbody = document.getElementById('table3-body');
            const totalCell = document.getElementById('table3-total');
            if (!tbody || !totalCell) return;

            // اولین بار: از دیتابیس پر کن
            if (tbody.children.length === 0 && window.currentLicenseData?.table3?.length > 0) {
                window.currentLicenseData.table3.forEach((row, idx) => {
                    const tr = document.createElement('tr');
                    tr.dataset.table3Id = row.id || '';
                    const totalPrice = toNumber(row.total_price);

                    tr.innerHTML = `
                        <td>${idx + 1}</td>
                        <td><input name="table3[${idx}][part_name]" class="form-control form-control-sm" value="${escapeHtml(row.part_name || '')}"></td>
                        <td><input name="table3[${idx}][quantity]" type="number" class="form-control form-control-sm" value="${row.quantity || 1}"></td>
                        <td><input name="table3[${idx}][unit]" class="form-control form-control-sm" value="${escapeHtml(row.unit || '')}"></td>
                        <td><input name="table3[${idx}][winner]" class="form-control form-control-sm" value="${escapeHtml(row.winner || '')}"></td>
                        <td><input name="table3[${idx}][total_price]" class="form-control form-control-sm text-center" value="${toPersianNumber(totalPrice)}" readonly></td>
                        <td class="text-center align-middle">
                            <button type="button" class="btn btn-sm text-danger opacity-75 hover-opacity-100"
                                    onclick="this.closest('tr').remove(); updateLicenseTable3()" title="حذف ردیف">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                // جمع کل اولیه
                let initialTotal = window.currentLicenseData.table3.reduce((sum, row) => sum + toNumber(row.total_price), 0);
                totalCell.textContent = toPersianNumber(initialTotal) + ' ریال';
                return;
            }

            // بعد از اولین بار: آپدیت خودکار با تغییرات کاربر
            let grandTotal = 0;

            tbody.querySelectorAll('tr').forEach((tr, idx) => {
                const partNameInput = tr.querySelector('input[name$="[part_name]"]');
                const quantityInput = tr.querySelector('input[name$="[quantity]"]');
                const winnerInput = tr.querySelector('input[name$="[winner]"]');
                const totalPriceInput = tr.querySelector('input[name$="[total_price]"]');

                if (!partNameInput || !quantityInput || !winnerInput || !totalPriceInput) return;

                const partName = partNameInput.value.trim();
                const winnerCompany = winnerInput.value.trim();
                const quantity = toNumber(quantityInput.value) || 1;

                let unitPrice = 0;

                const partCard = Array.from(document.querySelectorAll('#parts-container .card')).find(card => {
                    return card.querySelector('.part-name')?.value?.trim() === partName;
                });

                if (partCard && winnerCompany) {
                    const checkbox = partCard.querySelector(`.winner-checkbox:checked[value="${escapeForSelector(winnerCompany)}"]`);
                    if (checkbox) {
                        const priceInput = checkbox.closest('.input-group')?.querySelector('.winner-price');
                        unitPrice = toNumber(priceInput?.value);
                    }
                }

                const totalPrice = quantity * unitPrice;
                totalPriceInput.value = toPersianNumber(totalPrice);
                grandTotal += totalPrice;

                // آپدیت شماره ردیف
                tr.cells[0].textContent = idx + 1;
            });

            totalCell.textContent = toPersianNumber(grandTotal) + ' ریال';
        }

        // حذف ردیف → فقط آپدیت جدول
        function recalculateTable3Total() {
            updateLicenseTable3();
        }


        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addNewPart() {
            const container = document.getElementById('parts-container');
            const partIdx = container.querySelectorAll('.card').length;
            const newCard = document.createElement('div');
            newCard.className = 'card shadow mb-4';
            newCard.innerHTML = `
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">قطعه جدید ${partIdx + 1}</h6>
                    <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.card').remove(); updateLicenseTable3()">حذف</button>
                </div>
                <div class="card-body">
                    <fieldset class="mb-4 p-3 border rounded bg-light">
                        <legend class="w-auto px-2 fw-bold text-success legend-sm">اطلاعات قطعه</legend>
                        <div class="row g-3">
                            <div class="col-md-4"><label>نام قطعه</label><input name="new_parts[${partIdx}][part_name]" class="form-control form-control-sm part-name"></div>
                            <div class="col-md-3"><label>پارت نامبر</label><input name="new_parts[${partIdx}][part_number]" class="form-control form-control-sm"></div>
                            <div class="col-md-2"><label>تعداد</label><input name="new_parts[${partIdx}][quantity]" type="number" class="form-control form-control-sm part-quantity" value="1"></div>
                            <div class="col-md-3"><label>واحد</label><input name="new_parts[${partIdx}][unit]" class="form-control form-control-sm part-unit"></div>
                        </div>
                    </fieldset>
                    <fieldset class="p-3 border rounded bg-light">
                        <legend class="w-auto px-2 text-success legend-sm">قیمت‌های پیشنهادی شرکت‌ها</legend>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control form-control-sm" placeholder="نام شرکت">
                                    <input name="new_parts[${partIdx}][new_company_price]" class="form-control text-start winner-price" dir="ltr" placeholder="قیمت">
                                    <div class="input-group-text">
                                        <input type="checkbox" class="winner-checkbox" data-part-idx="${partIdx}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
            `;
            container.appendChild(newCard);
            updateLicenseTable3();
        }


        // هر تغییری → آپدیت خودکار
        $(document).off('input change', '#table3-body input, .winner-checkbox, .winner-price, .part-quantity, .part-name');
        $(document).on('input change', '#table3-body input, .winner-checkbox, .winner-price, .part-quantity, .part-name', updateLicenseTable3);

//****************************************************************************************************************

        //Appendix edit
        function populateAppendixModal(data, appendixCode) {
            const bodyId = '#editModalBody-appendix';
            $(bodyId).html(`
        <form id="appendixEditForm" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="appendix_code" value="${appendixCode}">

            <div class="row justify-content-center">
                <div class="col-12">

                    <!-- نوع الحاقیه -->
                    <h5 class="page-title account">نوع الحاقیه</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body account">
                            <div class="row">
                                ${data.type_choices.map(c => `
                                <div class="col-md-4">
                                    <div class="custom-control custom-radio radio-container">
                                        <input type="radio" class="custom-control-input" id="type_${c[0]}" name="appendix_type" value="${c[0]}" ${c[0] === data.appendix_type ? 'checked' : ''} required>
                                        <label class="custom-control-label" for="type_${c[0]}">${c[1]}</label>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- اطلاعات پایه -->
                    <h5 class="page-title account">اطلاعات پایه</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body account">
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group mb-3">
                                        <label><strong>عنوان قرارداد</strong></label>
                                        <input type="text" name="contract_title" class="form-control" value="${data.contract_title || ''}" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label><strong>پیمانکار/فروشنده</strong></label>
                                        <input type="text" name="contract_contractor" class="form-control" value="${data.contract_contractor || ''}">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label><strong>عنوان پروژه</strong></label>
                                        <input type="text" name="contract_projectname" class="form-control" value="${data.contract_projectname || ''}">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-3">
                                        <label><strong>شماره قرارداد</strong></label>
                                        <input type="text" name="contract_code" class="form-control" value="${data.contract_code || ''}">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label><strong>تاریخ شروع</strong></label>
                                        <input type="text" name="contract_startdate" class="form-control" value="${data.contract_startdate || ''}" data-jdp>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label><strong>تاریخ قرارداد</strong></label>
                                        <input type="text" name="contract_rundate" class="form-control" value="${data.contract_rundate || ''}" data-jdp>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-3">
                                        <label><strong>نوع قرارداد</strong></label>
                                        <select name="contract_type" class="form-control">
                                            <option value="">انتخاب کنید</option>
                                            <option value="لوازم اداری" ${data.contract_type === 'لوازم اداری' ? 'selected' : ''}>لوازم اداری</option>
                                            <option value="خرید" ${data.contract_type === 'خرید' ? 'selected' : ''}>خرید</option>
                                            <option value="فروش" ${data.contract_type === 'فروش' ? 'selected' : ''}>فروش</option>
                                            <option value="برون سپاری" ${data.contract_type === 'برون سپاری' ? 'selected' : ''}>برون سپاری</option>
                                            <option value="سایر" ${data.contract_type === 'سایر' ? 'selected' : ''}>سایر</option>
                                        </select>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label><strong>تاریخ پایان</strong></label>
                                        <input type="text" name="contract_enddate" class="form-control" value="${data.contract_enddate || ''}" data-jdp>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label><strong>گارانتی (روز)</strong></label>
                                        <input type="number" name="contract_warranty" class="form-control" value="${data.contract_warranty || ''}" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- اطلاعات مالی -->
                    <h5 class="page-title account">اطلاعات مالی</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body account">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label><strong>مبلغ قرارداد (ریال)</strong></label>
                                        <input type="text" name="contract_price" class="form-control persian-number" value="${data.contract_price || ''}">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label><strong>مبلغ قرارداد (دلار)</strong></label>
                                        <input type="text" name="contract_dollarprice" class="form-control persian-number" value="${data.contract_dollarprice || ''}">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label><strong>تاریخ قیمت دلاری</strong></label>
                                        <input type="text" name="contract_dollardate" class="form-control" value="${data.contract_dollardate || ''}" data-jdp>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تضامین و کسورات -->
                    <h5 class="page-title account">تضامین و کسورات</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body account">
                            <div class="row align-items-center mb-3">
                                <div class="col-md-5">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="has_prepayment" name="contract_hasprepayment" ${data.contract_hasprepayment ? 'checked' : ''}>
                                        <label class="custom-control-label" for="has_prepayment">پیش پرداخت دارد</label>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <input type="text" name="contract_prepayment" class="form-control" value="${data.contract_prepayment || ''}" placeholder="مقدار پیش‌پرداخت">
                                </div>
                            </div>
                            <div class="row align-items-center mb-3">
                                <div class="col-md-5">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="has_guarantee" name="contract_hasguarantee" ${data.contract_hasguarantee ? 'checked' : ''}>
                                        <label class="custom-control-label" for="has_guarantee">سپرده حسن انجام کار</label>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <input type="text" name="contract_guarantee" class="form-control" value="${data.contract_guarantee || ''}" placeholder="مقدار تضمین">
                                </div>
                            </div>
                            <div class="row align-items-center mb-3">
                                <div class="col-md-5">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="has_assurance" name="contract_hasassurance" ${data.contract_hasassurance ? 'checked' : ''}>
                                        <label class="custom-control-label" for="has_assurance">تضمین انجام تعهدات</label>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <input type="text" name="contract_assurance" class="form-control" value="${data.contract_assurance || ''}" placeholder="مقدار تعهد">
                                </div>
                            </div>
                            <div class="row align-items-center mb-3">
                                <div class="col-md-5">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="has_withholding" name="contract_haswithholding" ${data.contract_haswithholding ? 'checked' : ''}>
                                        <label class="custom-control-label" for="has_withholding">کسورات بیمه</label>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <input type="text" name="contract_withholding" class="form-control" value="${data.contract_withholding || ''}" placeholder="مقدار کسورات">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- اسناد قرارداد -->
<h5 class="page-title account">اسناد قرارداد</h5>
<div class="card shadow mb-4">
    <div class="card-body account">

        <!-- فایل‌های فعلی -->
        <div id="current-files-container">
            ${data.files.appendix_files.length > 0 ? data.files.appendix_files.map(f => `
                <div class="border rounded p-3 mb-3 bg-light file-item" data-file-id="${f.id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fa ${f.name.endsWith('.pdf') ? 'fa-file-pdf text-danger' : 'fa-file-image text-success'} fa-2x"></i>
                            <a href="${f.url}" target="_blank" class="ms-3 text-decoration-none">${f.name}</a>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm remove-current-file" data-file-id="${f.id}">
                            <i class="fa fa-trash"></i> حذف
                        </button>
                    </div>
                </div>
            `).join('') : '<p class="text-muted text-center py-3">هیچ فایلی آپلود نشده است.</p>'}
        </div>

        <!-- آپلود فایل جدید -->
        <div class="mt-4">
            <label class="form-label fw-bold text-success">آپلود فایل جدید (الحاقیه یا مجوز)</label>
            <input type="file" name="new_files" class="form-control" multiple accept=".pdf,.jpg,.jpeg,.png">
            <small class="text-muted">می‌تونید چند فایل همزمان آپلود کنید</small>
        </div>

    </div>
</div>



                    <!-- توضیحات -->
                    <h5 class="page-title account">توضیحات</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body account">
                            <textarea name="contract_description" class="form-control" rows="5">${data.contract_description || ''}</textarea>
                        </div>
                    </div>

                    <!-- واحدهای ابلاغ‌شده -->
                    <h5 class="page-title account">واحدهای ابلاغ‌شده</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body">
                            <select name="units" class="form-control" multiple size="6">
                                ${data.units_list.map(u => `<option value="${u.id}" ${data.units.includes(u.id) ? 'selected' : ''}>${u.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                </div>
            </div>
        </form>
    `);


            // حذف فایل فعلی (قبل از ذخیره)
            $(document).off('click', '.remove-current-file').on('click', '.remove-current-file', function () {
                const fileId = $(this).data('file-id');
                const $item = $(this).closest('.file-item');

                // افکت حذف بصری
                $item.fadeOut(300, function () {
                    $(this).remove();
                });

                // اضافه کردن به لیست فایل‌های حذف‌شده (برای ارسال به سرور)
                $('#appendixEditForm').append(
                    `<input type="hidden" name="delete_files" value="${fileId}">`
                );

                // اگر همه فایل‌ها حذف شدن، پیام مناسب نشون بده
                if ($('#current-files-container .file-item').length === 0) {
                    $('#current-files-container').html('<p class="text-muted text-center py-3">هیچ فایلی آپلود نشده است.</p>');
                }
            });

            // فعال‌سازی تقویم
            if (window.jalaliDatepicker) jalaliDatepicker.startWatch();
        }


        // deductions edit
        function populateDeductionsModal(data, contractCode) {

            const bodyId = '#editModalBody-deductions';
            const files = data.insurance_files || [];

            const filesHtml = files.length ? files.map(f => {
                const isImage = /\.(jpg|jpeg|png|gif)$/i.test(f.name);
                return `
        <div class="insurance-file-item mb-3">
            <div class="d-flex flex-column align-items-center">
                <div class="preview-box rounded mb-2">
                    ${isImage
                    ? `<img src="${f.url}" alt="${f.name}" class="img-preview rounded">`
                    : `<div class="pdf-icon rounded d-flex align-items-center justify-content-center">
                            <i class="fas fa-file-pdf fa-2x text-danger"></i>
                        </div>`
                }
                </div>
                <div class="d-flex gap-3">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-file" data-file-id="${f.id}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <a href="${f.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
            </div>
        </div>
        `;
            }).join('') : `
        <div class="text-muted text-center py-2">
            فایلی آپلود نشده است.
        </div>
    `;

            $(bodyId).html(`
        <form id="deductionsForm" enctype="multipart/form-data">
            <input type="hidden" name="contract_code" value="${contractCode}">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

            <!-- 1) کسورات -->
            <fieldset class="fieldset-gray mb-4">
                <legend class="fw-bold">کسورات</legend>

                ${renderDeductionRow('prepayment', 'پیش پرداخت', data.prepayment)}
                ${renderDeductionRow('guarantee', 'حسن انجام کار', data.guarantee)}
                ${renderDeductionRow('assurance', 'تضمین حسن انجام تعهدات', data.assurance)}
            </fieldset>

            <!-- 2) بیمه -->
            <fieldset class="fieldset-gray mb-4">
                <legend class="fw-bold">بیمه</legend>

                <div class="d-flex align-items-center justify-content-between border rounded p-2 mb-3">
                    <div>
                        <div class="fw-bold">بیمه و تعهدات</div>
                        <div class="small ${data.withholding.released ? 'text-success' : 'text-danger'}">
                            ${data.withholding.released ? `آزاد شده در ${data.withholding.release_date}` : 'در حال آزادسازی'}
                        </div>
                    </div>
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input guarantee-checkbox"
                               type="checkbox"
                               id="insurance"
                               name="insurance_released"
                               ${data.withholding.released ? 'checked' : ''}>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-7">
                        <div id="insurance-files-list" class="d-flex flex-wrap gap-3">
                            ${filesHtml}
                        </div>
                    </div>

                    <div class="p-0">
                            <label class="form-label fw-bold">آپلود فایل جدید</label>
                            <input type="file" class="form-control form-control-sm"
                                   name="insurance_file"
                             accept=".pdf,.jpg,.jpeg,.png">
                    </div>

                </div>

            </fieldset>

            <!-- 3) توضیحات -->
            <fieldset class="fieldset-gray mb-3">
                <legend class="fw-bold">توضیحات</legend>
                <textarea class="form-control" name="insurance_notes" rows="7" style="height:100px;"
                          placeholder="توضیحات مربوط به مفاصاحساب"></textarea>
            </fieldset>

        </form>
    `);

            // حذف فایل
            $(document).off('click', '.remove-file').on('click', '.remove-file', function () {
                const fileId = $(this).data('file-id');
                $(this).closest('.insurance-file-item').remove();
                $('#deductionsForm').append(`<input type="hidden" name="delete_file_ids[]" value="${fileId}">`);
            });

            function renderDeductionRow(id, label, dataField) {
                return `
            <div class="d-flex align-items-center justify-content-between border rounded p-2 mb-2">
                <div>
                    <div class="fw-bold">${label}</div>
                    <div class="small ${dataField.released ? 'text-success' : 'text-danger'}">
                        ${dataField.released ? `آزاد شده در ${dataField.release_date}` : 'در حال آزادسازی'}
                    </div>
                </div>
                <div class="form-check form-switch m-0">
                    <input class="form-check-input guarantee-checkbox"
                           type="checkbox"
                           id="${id}"
                           name="${id}_released"
                           ${dataField.released ? 'checked' : ''}>
                </div>
            </div>
        `;
            }
        }



            function calculateDeductionsTotal() {
                let total = 0;
                $('.deduction-amount').each(function () {
                    total += parseFloat($(this).val()) || 0;
                });
                $('#total_deductions').text(total.toLocaleString() + ' ریال');
            }

            //invoice edit
            function populateEditModal(invoiceData, invoiceId, tabId) {
                const bodyId = `#editModalBody-${tabId}`;
                const modalBody = document.querySelector(bodyId); // یا $(bodyId)[0]

                if (!modalBody) {
                    console.error('modalBody not found:', bodyId);
                    return;
                }

                const modalTitle = document.querySelector(`#editModal-${tabId} .modal-title`);
                if (modalTitle) {
                    modalTitle.textContent = `ویرایش فاکتور: ${invoiceData.subject || 'بدون عنوان'} (${invoiceId})`;
                }

                // --- بقیه کد همون قبلی ---
                const parts = invoiceData.parts || [];
                const images = invoiceData.images || [];

                const partsHtml = parts.length > 0 ? parts.map((part, index) => `
        <tr class="part-row" data-index="${index}">
            <td><input type="text" class="form-control form-control-sm" name="parts[${index}][part_name]" value="${part.part_name || ''}" required></td>
            <td><input type="text" class="form-control form-control-sm" name="parts[${index}][part_number]" value="${part.part_number || ''}"></td>
            <td><input type="number" class="form-control form-control-sm part-quantity" name="parts[${index}][quantity]" value="${part.quantity || 1}" min="1"></td>
            <td><input type="number" class="form-control form-control-sm part-unit-price" name="parts[${index}][unit_price]" value="${part.unit_price || 0}" min="0" step="0.01"></td>
            <td><input type="text" class="form-control form-control-sm part-subtotal bg-light" value="${(part.subtotal || 0).toLocaleString()}" readonly></td>
            <td><button type="button" class="btn btn-sm btn-danger remove-part">حذف</button></td>
        </tr>
    `).join('') : '<tr><td colspan="6" class="text-center text-muted py-2">هیچ قطعه‌ای وجود ندارد.</td></tr>';

                const imagesHtml = images.length > 0 ? images.map(img => `
        <div class="image-preview mb-2">
            <img src="${img.image || ''}" alt="تصویر" class="img-thumbnail" style="max-width: 200px;">
            <button type="button" class="btn btn-sm btn-danger remove-image" data-image-id="${img.id || ''}">حذف</button>
        </div>
    `).join('') : '<p class="text-muted">هیچ تصویری وجود ندارد.</p>';

                modalBody.innerHTML = `
        <form id="editInvoiceForm-${tabId}">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <input type="hidden" name="invoice_id" value="${invoiceId}">
            <!-- اطلاعات پایه -->
            <fieldset class="mb-3 border p-3 rounded bg-light">
                <legend class="font-weight-bold text-primary">اطلاعات پایه فاکتور</legend>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label>موضوع فاکتور</label>
                        <input type="text" class="form-control" name="subject" value="${invoiceData.subject || ''}" required>
                    </div>
                    <div class="col-md-6">
                        <label>فروشنده/پیمانکار</label>
                        <input type="text" class="form-control" name="vendor" value="${invoiceData.vendor || ''}" required>
                    </div>
                    <div class="col-md-6">
                        <label>تاریخ فاکتور</label>
                        <input type="text" class="form-control" name="invoice_date" data-jdp value="${invoiceData.invoice_date || ''}" required>
                    </div>
                    <div class="col-md-6">
                        <label>توضیحات</label>
                        <textarea class="form-control" name="description" rows="2">${(invoiceData.description || '').replace(/`/g, '&#96;')}</textarea>
                    </div>
                </div>
            </fieldset>
            <!-- نحوه خرید و مالیات -->
            <fieldset class="mb-3 border p-3 rounded bg-light">
                <legend class="font-weight-bold text-primary">نحوه خرید و محاسبات مالی</legend>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label>نحوه خرید</label>
                        <select class="form-select" id="edit_purchase_type-${tabId}" name="purchase_type">
                            <option value="cash">نقدی</option>
                            <option value="non_cash">غیرنقدی</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_vat_applied-${tabId}" name="vat_applied">
                            <label class="form-check-label" for="edit_vat_applied-${tabId}">مالیات بر ارزش افزوده</label>
                        </div>
                        <div class="input-group mt-1">
                            <input type="number" class="form-control" id="edit_vat_rate-${tabId}" name="vat_rate" value="${invoiceData.vat_rate || 9}" min="0" max="100">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_bond_applied-${tabId}" name="bond_applied">
                            <label class="form-check-label" for="edit_bond_applied-${tabId}">کسر حسن انجام کار</label>
                        </div>
                        <div class="input-group mt-1">
                            <input type="number" class="form-control" id="edit_bond_rate-${tabId}" name="bond_rate" value="${invoiceData.bond_rate || 10}" min="0" max="100">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
            </fieldset>
            <!-- لیست قطعات -->
            <fieldset class="mb-3 border p-3 rounded bg-light">
                <legend class="font-weight-bold text-primary">لیست قطعات</legend>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>نام قطعه</th><th>پارت نامبر</th><th>تعداد</th><th>قیمت واحد</th><th>جمع ردیف</th><th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="edit_parts_tbody-${tabId}">${partsHtml}</tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-sm btn-success" id="add_part_btn-${tabId}">افزودن قطعه</button>
            </fieldset>
            <!-- محاسبات نهایی -->
            <fieldset class="mb-3 border p-3 rounded bg-light">
                <legend class="font-weight-bold text-primary">محاسبات نهایی</legend>
                <div class="row g-3">
                    <div class="col-md-3"><strong>جمع خالص:</strong> <span id="edit_net_total-${tabId}" class="text-primary">${(invoiceData.net_total || 0).toLocaleString()} ریال</span></div>
                    <div class="col-md-3"><strong>مبلغ مالیات:</strong> <span id="edit_vat_amount-${tabId}" class="text-success">${(invoiceData.vat_amount || 0).toLocaleString()} ریال</span></div>
                    <div class="col-md-3"><strong>کسر حسن انجام:</strong> <span id="edit_bond_amount-${tabId}" class="text-danger">${(invoiceData.bond_amount || 0).toLocaleString()} ریال</span></div>
                    <div class="col-md-3"><strong>جمع نهایی:</strong> <span id="edit_final_total-${tabId}" class="text-info">${(invoiceData.final_total || 0).toLocaleString()} ریال</span></div>
                </div>
            </fieldset>
            <!-- تصاویر -->
            <fieldset class="mb-3 border p-3 rounded bg-light">
                <legend class="font-weight-bold text-primary">تصاویر فاکتور</legend>
                <div id="edit_images_container-${tabId}">${imagesHtml}</div>
                <input type="file" class="form-control mt-2" name="invoice_image" accept="image/*,.pdf">
            </fieldset>
        </form>
    `;

                // تنظیم مقادیر
                $(`#edit_purchase_type-${tabId}`).val(invoiceData.purchase_type || 'cash');
                $(`#edit_vat_applied-${tabId}`).prop('checked', !!invoiceData.vat_applied);
                $(`#edit_bond_applied-${tabId}`).prop('checked', !!invoiceData.bond_applied);

                calculateEditTotals(tabId);
                attachEditModalEvents(tabId);
            }

            //Contract Edit
            function populateContractEditModal(data, contractCode, tabId) {
                const bodyId = '#editModalBody-' + tabId;

                // تابع حذف فایل (مشترک برای همه)
                window.deleteContractFile = function (fileId, fileType, element) {
                    Swal.fire({
                        title: 'مطمئنی؟',
                        text: "این فایل برای همیشه حذف میشه!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'بله، حذف کن',
                        cancelButtonText: 'نه، لغو'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                url: '/contractDashboard/delete-contract-file/',
                                type: 'POST',
                                data: {
                                    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
                                    file_id: fileId,
                                    file_type: fileType,
                                    contract_code: contractCode
                                },
                                success: function (res) {
                                    if (res.success) {
                                        $(element).closest('.file-item').fadeOut(300, function () {
                                            $(this).remove();
                                        });
                                        Swal.fire('حذف شد!', 'فایل با موفقیت حذف شد.', 'success');
                                    } else {
                                        Swal.fire('خطا', res.message || 'حذف نشد!', 'error');
                                    }
                                },
                                error: () => Swal.fire('خطا', 'ارتباط با سرور قطع شد.', 'error')
                            });
                        }
                    });
                };

                // تابع حذف کامل الحاقیه
                window.deleteFullAppendix = function (appendixCode, element) {
                    Swal.fire({
                        title: 'حذف کامل الحاقیه',
                        text: `الحاقیه ${appendixCode} و تمام فایل‌های آن برای همیشه حذف می‌شود!`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'بله، حذف کن',
                        cancelButtonText: 'لغو',
                        confirmButtonColor: '#dc3545'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            fetch("{% url 'contract:delete_appendix' %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                },
                                body: JSON.stringify({appendix_code: appendixCode})
                            })
                                .then(r => r.json())
                                .then(res => {
                                    if (res.success) {
                                        // حذف ردیف الحاقیه از مودال
                                        $(element).closest('.appendix-item').fadeOut(500, function () {
                                            $(this).remove();
                                        });
                                        Swal.fire('حذف شد!', 'الحاقیه با موفقیت حذف شد.', 'success');
                                    } else {
                                        Swal.fire('خطا', res.message || 'حذف نشد!', 'error');
                                    }
                                })
                                .catch(() => Swal.fire('خطا', 'ارتباط با سرور قطع شد.', 'error'));
                        }
                    });
                };

                $(bodyId).html(`
            <form id="contractEditForm" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="contract_code" value="${contractCode}">

            <div class="row justify-content-center">
                <div class="col-12">

                    <!-- اطلاعات پایه قرارداد -->
                    <h5 class="page-title account">اطلاعات پایه قرارداد</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body account">
                            <div class="row">

                                <div class="col-md-6 mb-3">
                                    <label><strong>عنوان قرارداد</strong></label>
                                    <input type="text" name="contract_title" class="form-control" value="${data.contract_title || ''}" required>
                                </div>

                                <div class="col-md-3 mb-3">
                                    <label><strong>شماره قرارداد</strong></label>
                                    <input type="text" name="contract_code" class="form-control" value="${data.contract_code || ''}" readonly>
                                </div>

                                <div class="col-md-3 mb-3">
                                    <label><strong>نوع قرارداد</strong></label>
                                    <select name="contract_type" class="form-control">
                                        <option value="">انتخاب کنید</option>
                                        <option value="لوازم اداری" ${data.contract_type === 'لوازم اداری' ? 'selected' : ''}>لوازم اداری</option>
                                        <option value="خرید" ${data.contract_type === 'خرید' ? 'selected' : ''}>خرید</option>
                                        <option value="فروش" ${data.contract_type === 'فروش' ? 'selected' : ''}>فروش</option>
                                        <option value="برون سپاری" ${data.contract_type === 'برون سپاری' ? 'selected' : ''}>برون سپاری</option>
                                        <option value="سایر" ${data.contract_type === 'سایر' ? 'selected' : ''}>سایر</option>
                                    </select>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label><strong>پیمانکار</strong></label>
                                    <input type="text" name="contract_contractor" class="form-control" value="${data.contract_contractor || ''}">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label><strong>تاریخ شروع</strong></label>
                                    <input type="text" name="contract_startdate" class="form-control" value="${data.contract_startdate || ''}" data-jdp>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label><strong>تاریخ پایان</strong></label>
                                    <input type="text" name="contract_enddate" class="form-control" value="${data.contract_enddate || ''}" data-jdp>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label><strong>تاریخ اجرا</strong></label>
                                    <input type="text" name="contract_rundate" class="form-control" value="${data.contract_rundate || ''}" data-jdp>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label><strong>مدت قرارداد (روز)</strong></label>
                                    <input type="number" name="contract_period" class="form-control" value="${data.contract_period || ''}">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label><strong>گارانتی (ماه)</strong></label>
                                    <input type="number" name="contract_warranty" class="form-control" value="${data.contract_warranty || ''}">
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- اطلاعات مالی -->
                    <h5 class="page-title account">اطلاعات مالی</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body account">
                            <div class="row">

                                <div class="col-md-4 mb-3">
                                    <label><strong>مبلغ قرارداد (ریال)</strong></label>
                                    <input type="text" name="contract_price" class="form-control" value="${data.contract_price || ''}">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label><strong>مبلغ دلاری</strong></label>
                                    <input type="text" name="contract_dollarprice" class="form-control" value="${data.contract_dollarprice || ''}">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label><strong>تاریخ نرخ دلار</strong></label>
                                    <input type="text" name="contract_dollardate" class="form-control" value="${data.contract_dollardate || ''}" data-jdp>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- تضامین و کسورات -->
                    <h5 class="page-title account">تضامین و کسورات</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body account">

                            <div class="row align-items-center mb-3">
                                <div class="col-md-5">
                                    <div class="form-check form-switch">
                                        <input class="" type="checkbox" id="has_prepayment" name="contract_hasprepayment" ${data.contract_hasprepayment ? 'checked' : ''}>
                                        <label class="form-check-label" for="has_prepayment">پیش‌پرداخت دارد</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" name="contract_prepayment" class="form-control" value="${data.contract_prepayment || ''}" placeholder="مقدار پیش‌پرداخت">
                                </div>
                            </div>

                            <div class="row align-items-center mb-3">
                                <div class="col-md-5">
                                    <div class="form-check form-switch">
                                        <input class="" type="checkbox" id="has_guarantee" name="contract_hasguarantee" ${data.contract_hasguarantee ? 'checked' : ''}>
                                        <label class="form-check-label" for="has_guarantee">حسن انجام کار</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" name="contract_guarantee" class="form-control" value="${data.contract_guarantee || ''}" placeholder="مقدار تضمین">
                                </div>
                            </div>

                            <div class="row align-items-center mb-3">
                                <div class="col-md-5">
                                    <div class="form-check form-switch">
                                        <input class="" type="checkbox" id="has_assurance" name="contract_hasassurance" ${data.contract_hasassurance ? 'checked' : ''}>
                                        <label class="form-check-label" for="has_assurance">تعهدات</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" name="contract_assurance" class="form-control" value="${data.contract_assurance || ''}" placeholder="مقدار تعهد">
                                </div>
                            </div>

                            <div class="row align-items-center mb-3">
                                <div class="col-md-5">
                                    <div class="form-check form-switch">
                                        <input class="" type="checkbox" id="has_withholding" name="contract_haswithholding" ${data.contract_haswithholding ? 'checked' : ''}>
                                        <label class="form-check-label" for="has_withholding">کسورات قانونی</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" name="contract_withholding" class="form-control" value="${data.contract_withholding || ''}" placeholder="مقدار کسورات">
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- توضیحات -->
                    <h5 class="page-title account">توضیحات</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body account">
                            <textarea name="contract_description" class="form-control" rows="5">${data.contract_description || ''}</textarea>
                        </div>
                    </div>

                    <!-- واحدهای ابلاغ شده -->
                    <h5 class="page-title account">واحدهای ابلاغ‌شده</h5>
                    <div class="card shadow mb-4">
                        <div class="card-body">
                            <select name="units" class="form-control" multiple size="8">
                                ${data.units_list.map(u => `
                                    <option value="${u.id}" ${data.units.includes(u.id) ? 'selected' : ''}>${u.unit_name}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ==================== بخش جدید: اسناد و فایل‌ها ==================== -->
            <h5 class="page-title account mt-5">اسناد و فایل‌های قرارداد</h5>
            <div class="card shadow mb-4">
                <div class="card-body">

                    <!-- ۱. تصاویر قرارداد -->
                    <div class="mb-4">
                        <h6 class="text-primary"><i class="fas fa-file-contract"></i> تصاویر قرارداد</h6>
                        <div class="border rounded p-3 bg-light">
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                ${data.contract_imgs && data.contract_imgs.length > 0 ? data.contract_imgs.map(f => `
                                    <div class="file-item d-flex align-items-center gap-2 border rounded p-2 bg-white">
                                        <i class="fas ${f.name.endsWith('.pdf') ? 'fa-file-pdf text-danger' : 'fa-file-image text-success'} fa-lg"></i>
                                        <span class="small flex-grow-1">${f.name}</span>
                                        <button type="button" class="btn btn-sm btn-info" onclick="window.open('${f.url}', '_blank')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteContractFile(${f.id}, 'contract_img', this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('') : '<span class="text-muted small">هیچ فایلی آپلود نشده</span>'}
                                <!-- آپلود جدید در همان ردیف -->
                                <label class="btn btn-sm btn-outline-success m-0">
                                    <span class="file-display-text"><i class="fas fa-upload"></i> آپلود جدید</span>
                                    <input type="file" name="contract_imgs" class="d-none" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ۲. مصوبه کمیسیون -->
                    <div class="mb-4">
                        <h6 class="text-warning"><i class="fas fa-users"></i> مصوبه کمیسیون معاملات</h6>
                        <div class="border rounded p-3 bg-light">
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                ${data.commission_imgs && data.commission_imgs.length > 0 ? data.commission_imgs.map(f => `
                                    <div class="file-item d-flex align-items-center gap-2 border rounded p-2 bg-white">
                                        <i class="fas ${f.name.endsWith('.pdf') ? 'fa-file-pdf text-danger' : 'fa-file-image text-success'} fa-lg"></i>
                                        <span class="small flex-grow-1">${f.name}</span>
                                        <button type="button" class="btn btn-sm btn-info" onclick="window.open('${f.url}', '_blank')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteContractFile(${f.id}, 'commission_img', this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('') : '<span class="text-muted small">هیچ فایلی آپلود نشده</span>'}
                                <label class="btn btn-sm btn-outline-success m-0">
                                    <span class="file-display-text"><i class="fas fa-upload"></i> آپلود جدید</span>
                                    <input type="file" name="commission_imgs" class="d-none" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ۳. مصوبه هیئت مدیره -->
                    <div class="mb-4">
                        <h6 class="text-info"><i class="fas fa-gavel"></i> مصوبه هیئت مدیره</h6>
                        <div class="border rounded p-3 bg-light">
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                ${data.approval_imgs && data.approval_imgs.length > 0 ? data.approval_imgs.map(f => `
                                    <div class="file-item d-flex align-items-center gap-2 border rounded p-2 bg-white">
                                        <i class="fas ${f.name.endsWith('.pdf') ? 'fa-file-pdf text-danger' : 'fa-file-image text-success'} fa-lg"></i>
                                        <span class="small flex-grow-1">${f.name}</span>
                                        <button type="button" class="btn btn-sm btn-info" onclick="window.open('${f.url}', '_blank')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteContractFile(${f.id}, 'approval_img', this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('') : '<span class="text-muted small">هیچ فایلی آپلود نشده</span>'}
                                <label class="btn btn-sm btn-outline-success m-0">
                                   <span class="file-display-text"><i class="fas fa-upload"></i> آپلود جدید</span>
                                    <input type="file" name="approval_imgs" class="d-none" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ۴. تصویر چک تضمین -->
                    <div class="mb-4">
                        <h6 class="text-success"><i class="fas fa-money-check"></i> تصویر چک تضمین</h6>
                        <div class="border rounded p-3 bg-light">
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                ${data.check_imgs && data.check_imgs.length > 0 ? data.check_imgs.map(f => `
                                    <div class="file-item d-flex align-items-center gap-2 border rounded p-2 bg-white">
                                        <i class="fas ${f.name.endsWith('.pdf') ? 'fa-file-pdf text-danger' : 'fa-file-image text-success'} fa-lg"></i>
                                        <span class="small flex-grow-1">${f.name}</span>
                                        <button type="button" class="btn btn-sm btn-info" onclick="window.open('${f.url}', '_blank')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteContractFile(${f.id}, 'check_img', this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('') : '<span class="text-muted small">هیچ فایلی آپلود نشده</span>'}
                                <label class="btn btn-sm btn-outline-success m-0">
                                    <span class="file-display-text"><i class="fas fa-upload"></i> آپلود جدید</span>
                                    <input type="file" name="check_imgs" class="d-none" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ۵. الحاقیه‌ها -->
                   <!-- الحاقیه‌ها (با دکمه حذف کامل الحاقیه) -->
                    <div class="mb-4">
                        <h6 class="text-secondary"><i class="fas fa-paperclip"></i> الحاقیه‌ها</h6>
                        ${data.appendices && data.appendices.length > 0 ? data.appendices.map(app => `
                            <div class="appendix-item border rounded p-4 mb-4 bg-light position-relative">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <strong>${app.appendix_code} - ${app.appendix_type_display}</strong>
                                    <button type="button" class="btn btn-sm btn-danger"
                                            onclick="deleteFullAppendix('${app.appendix_code}', this)">
                                        <i class="fas fa-trash-alt"></i> حذف کامل الحاقیه
                                    </button>
                                </div>

                                <div class="d-flex align-items-center gap-3 flex-wrap">
                                    ${app.files && app.files.length > 0 ? app.files.map(f => `
                                        <div class="file-item d-flex align-items-center gap-2 border rounded p-2 bg-white">
                                            <i class="fas ${f.name.endsWith('.pdf') ? 'fa-file-pdf text-danger' : 'fa-file-image text-success'} fa-lg"></i>
                                            <span class="small flex-grow-1">${f.name}</span>
                                            <button type="button" class="btn btn-sm btn-info" onclick="window.open('${f.url}', '_blank')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteContractFile(${f.id}, 'appendix_file', this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    `).join('') : '<span class="text-muted small">فایلی ندارد</span>'}

                                    <!-- آپلود جدید برای این الحاقیه -->
                                    <label class="btn btn-sm btn-outline-success m-0">
                                        <span class="file-display-text"><i class="fas fa-upload"></i> آپلود جدید</span>
                                        <input type="file" name="appendix_${app.appendix_code}" class="d-none" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                    </label>
                                </div>
                            </div>
                        `).join('') : '<p class="text-muted">الحاقیه‌ای ثبت نشده است.</p>'}
                    </div>

                </div>
            </div>
        </form>
    `);

                // فعال‌سازی تقویم
                if (window.jalaliDatepicker) jalaliDatepicker.startWatch();
            }


            function attachEditModalEvents(tabId) {
                const bodyId = `#editModalBody-${tabId}`;
                $(document).off('input', `${bodyId} .part-quantity, ${bodyId} .part-unit-price`);
                $(document).on('input', `${bodyId} .part-quantity, ${bodyId} .part-unit-price`, function () {
                    const $row = $(this).closest('.part-row');
                    const qty = parseFloat($row.find('.part-quantity').val()) || 0;
                    const price = parseFloat($row.find('.part-unit-price').val()) || 0;
                    $row.find('.part-subtotal').val((qty * price).toLocaleString() + ' ریال');
                    calculateEditTotals(tabId);
                });

                $(document).off('click', `${bodyId} #add_part_btn-${tabId}`).on('click', `${bodyId} #add_part_btn-${tabId}`, function () {
                    const index = $(`${bodyId} #edit_parts_tbody-${tabId} tr`).length;
                    const newRow = `
            <tr class="part-row" data-index="${index}">
                <td><input type="text" class="form-control form-control-sm" name="parts[${index}][part_name]" required></td>
                <td><input type="text" class="form-control form-control-sm" name="parts[${index}][part_number]"></td>
                <td><input type="number" class="form-control form-control-sm part-quantity" name="parts[${index}][quantity]" value="1" min="1"></td>
                <td><input type="number" class="form-control form-control-sm part-unit-price" name="parts[${index}][unit_price]" value="0" min="0" step="0.01"></td>
                <td><input type="text" class="form-control form-control-sm part-subtotal bg-light" value="0 ریال" readonly></td>
                <td><button type="button" class="btn btn-sm btn-danger remove-part">حذف</button></td>
            </tr>
        `;
                    $(`${bodyId} #edit_parts_tbody-${tabId}`).append(newRow);
                    calculateEditTotals(tabId);
                });

                $(document).off('click', `${bodyId} .remove-part`).on('click', `${bodyId} .remove-part`, function () {
                    $(this).closest('.part-row').remove();
                    calculateEditTotals(tabId);
                });

            }

            function calculateEditTotals(tabId) {
                const bodyId = `#editModalBody-${tabId}`;
                let netTotal = 0;
                $(`${bodyId} .part-row`).each(function () {
                    const subtotalText = $(this).find('.part-subtotal').val() || '0';
                    const subtotal = parseFloat(subtotalText.replace(/[^\d]/g, '')) || 0;
                    netTotal += subtotal;
                });
                $(`${bodyId} #edit_net_total-${tabId}`).text(netTotal.toLocaleString() + ' ریال');

                let vat = 0, bond = 0, final = netTotal;
                if ($(`#edit_vat_applied-${tabId}`).is(':checked')) {
                    const rate = parseFloat($(`#edit_vat_rate-${tabId}`).val()) || 0;
                    vat = netTotal * rate / 100;
                    final += vat;
                }
                if ($(`#edit_bond_applied-${tabId}`).is(':checked')) {
                    const rate = parseFloat($(`#edit_bond_rate-${tabId}`).val()) || 0;
                    const base = netTotal + vat;
                    bond = base * rate / 100;
                    final = base - bond;
                }
                $(`${bodyId} #edit_vat_amount-${tabId}`).text(vat.toLocaleString() + ' ریال');
                $(`${bodyId} #edit_bond_amount-${tabId}`).text(bond.toLocaleString() + ' ریال');
                $(`${bodyId} #edit_final_total-${tabId}`).text(final.toLocaleString() + ' ریال');
            }


            //**************************************************** SAVE EDIT  **********************************************


            $(document).on('click', '.temp-save-btn', function () {

                const tabId = $(this).data('tab');

                if (tabId == 'deductions') {
                    const $btn = $(this);
                    if ($btn.prop('disabled')) return;

                    const formData = new FormData($('#deductionsForm')[0]);

                    // چک‌باکس‌ها رو دستی بفرست
                    $('.guarantee-checkbox').each(function () {
                        formData.set(this.name, this.checked ? 'true' : 'false');
                    });

                    $.ajax({
                        url: "/contractDashboard/release-edited-guarantess/",
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        cache: false,
                        beforeSend: () => {
                            $btn.prop('disabled', true)
                                .html('در حال ذخیره... <i class="fas fa-spinner fa-spin ms-2"></i>');
                        },
                        success: (res) => {
                            if (res.success) {
                                Swal.fire('موفقیت!', res.message || 'تغییرات با موفقیت ذخیره شد.', 'success');
                                setTimeout(() => location.reload(), 1200);
                            } else {
                                Swal.fire('خطا', res.message || 'ذخیره نشد!', 'error');
                            }
                        },
                        error: (xhr) => {
                            console.error('AJAX Error:', xhr.responseText);
                            Swal.fire('خطا', 'خطا در ارتباط با سرور.', 'error');
                        },
                        complete: () => {
                            $btn.prop('disabled', false).html('ذخیره تغییرات');
                        }
                    });
                } else if (tabId == 'pills-currrent') {


                } else if (tabId == 'appendix') {


                    const $btn = $(this);
                    if ($btn.hasClass('loading')) return;

                    const form = $('#appendixEditForm')[0];
                    if (!form) return;

                    const formData = new FormData(form);

                    // اضافه کردن فایل‌های حذف in delete_files (حذف شده‌ها)
                    $('.remove-current-file').each(function () {
                        if ($(this).hasClass('removed')) {
                            formData.append('delete_files', $(this).data('file-id'));
                        }
                    });

                    // غیرفعال کردن دکمه
                    $btn.addClass('loading').prop('disabled', true)
                        .html('<i class="fa fa-spinner fa-spin"></i> در حال ذخیره...');

                    $.ajax({
                        url: '/contractDashboard/appendix_edit_ajax/',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                        },
                        success: function (res) {
                            if (res.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'موفقیت!',
                                    text: res.message || 'الحاقیه با موفقیت بروزرسانی شد.',
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    $('#editModal-appendix').modal('hide');
                                    // رفرش صفحه یا فقط کارت الحاقیه
                                    location.reload();
                                });
                            } else {
                                Swal.fire('خطا', res.error || 'ذخیره انجام نشد.', 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('خطا', 'مشکل در ارتباط با سرور. لطفاً دوباره تلاش کنید.', 'error');
                        },
                        complete: function () {
                            $btn.removeClass('loading').prop('disabled', false)
                                .html('<i class="fa fa-save"></i> ذخیره تغییرات');
                        }
                    });


                } else if (tabId === 'contracted' || tabId === 'contractNotified') {

                    const $btn = $('#tempSaveBtn');
                    if ($btn.prop('disabled')) return;

                    const formData = new FormData($('#contractEditForm')[0]);

                    $.ajax({
                        url: '/contractDashboard/contract-edit-save/',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        beforeSend: () => {
                            $btn.prop('disabled', true).html('در حال ذخیره... <i class="fas fa-spinner fa-spin"></i>');
                        },
                        success: (res) => {
                            if (res.success) {
                                Swal.fire('موفقیت!', 'قرارداد با موفقیت بروزرسانی شد.', 'success');
                                setTimeout(() => location.reload(), 1200);
                            } else {
                                Swal.fire('خطا', res.message || 'ذخیره نشد!', 'error');
                            }
                        },
                        error: () => Swal.fire('خطا', 'ارتباط با سرور قطع شد.', 'error'),
                        complete: () => $btn.prop('disabled', false).html('ذخیره تغییرات')
                    });
                } else if (tabId === 'mycartable') {
                    const $btn = $(this);
                    if ($btn.prop('disabled')) return;

                    const $form = $('.license-edit-form');
                    if (!$form.length) {
                        Swal.fire('خطا', 'فرم مجوز یافت نشد!', 'error');
                        return;
                    }

                    const invoiceCode = $form.data('invoice-code');
                    if (!invoiceCode) {
                        Swal.fire('خطا', 'شماره فاکتور مشخص نیست!', 'error');
                        return;
                    }

                    // مهم: از کل فرم FormData بگیریم → همه چیز میاد (قطعات، جنرال، چک‌باکس‌ها، شرکت‌ها و ...)
                    const formData = new FormData($form[0]);

                    // فقط table3 رو دستی اضافه کنیم (چون ممکنه کاربر تغییر داده باشه و inputها readonly باشن یا name نداشته باشن)
                    let rowIndex = 0;
                    $('#table3-body tr').each(function () {
                        const $tr = $(this);

                        const partName = ($tr.find('input[name*="part_name"]').val() || '').trim();
                        const quantity = $tr.find('input[name*="quantity"]').val() || '1';
                        const unit = ($tr.find('input[name*="unit"]').val() || '').trim();
                        const winner = ($tr.find('input[name*="winner"]').val() || '').trim();
                        const totalPriceRaw = ($tr.find('input[name*="total_price"]').val() || '0').trim();
                        const totalPrice = toNumber(totalPriceRaw);

                        // حتی اگر خالی باشه هم می‌فرستیم؟ نه! فقط اگر حداقل یه فیلد مهم پر باشه
                        if (partName || winner) {
                            formData.append(`table3[${rowIndex}][part_name]`, partName);
                            formData.append(`table3[${rowIndex}][quantity]`, quantity);
                            formData.append(`table3[${rowIndex}][unit]`, unit);
                            formData.append(`table3[${rowIndex}][winner]`, winner);
                            formData.append(`table3[${rowIndex}][total_price]`, totalPrice);

                            // اگر ردیف از دیتابیس لود شده بود
                            const rowId = $tr.data('table3id') || $tr.attr('data-table3id');
                            if (rowId) {
                                formData.append(`table3[${rowIndex}][id]`, rowId);
                            }

                            rowIndex++;
                        }
                    });

                    // مطمئن شو invoice_code حتماً باشه (حتی اگر فرم خراب باشه)
                    formData.set('invoice_code', invoiceCode);

                    // لودینگ
                    $btn.prop('disabled', true)
                        .html('<i class="fa fa-spinner fa-spin"></i> در حال ذخیره...');

                    $.ajax({
                        url: '/contractDashboard/licensetemp-edit-save/',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        cache: false,
                        headers: {
                            'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val() || getCookie('csrftoken')
                        },
                        success: function (res) {
                            if (res.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'موفقیت!',
                                    text: res.message || 'همه تغییرات با موفقیت ذخیره شد.',
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire('خطا', res.message || 'ذخیره انجام نشد!', 'error');
                            }
                        },
                        error: function (xhr) {
                            console.error('AJAX Error:', xhr.responseText);
                            Swal.fire('خطای سرور', 'مشکلی پیش آمد. جزئیات در کنسول.', 'error');
                        },
                        complete: function () {
                            $btn.prop('disabled', false)
                                .html('ذخیره تمام تغییرات');
                        }
                    });

                }


            });

        }


        document.getElementById('startPrinting').addEventListener('click', function () {
            const invoiceCode = document.getElementById('print_invoice_code').value;
            const items = Array.from(document.querySelectorAll('.print-item:checked'))
                .map(cb => cb.value);

            if (items.length === 0) {
                Swal.fire('هشدار', 'لطفاً حداقل یک مورد را انتخاب کنید.', 'warning');
                return;
            }

            const url = `/contractDashboard/print-selected/${encodeURIComponent(invoiceCode)}/?items=${items.join(',')}`;

            {#window.open(url, '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes');#}

            // پنجره جدید باز کن
            const printWindow = window.open(url, '_blank', 'width=1100,height=800');
            // وقتی صفحه کامل لود شد، اتوماتیک پرینت پریویو باز بشه
            printWindow.onload = function () {
                printWindow.focus();           // فوکوس روی پنجره جدید
                printWindow.print();           // این خط مهم است! پرینت پریویو باز میشه
            };

            bootstrap.Modal.getInstance(document.getElementById('printOptionsModal')).hide();
        });


        // مدیریت دکمه "انتخاب همه" در مودال پرینت
        document.addEventListener('DOMContentLoaded', function () {
            const selectAllBtn = document.getElementById('selectAllPrint');
            if (!selectAllBtn) return;

            selectAllBtn.addEventListener('change', function () {
                const waiting = document.getElementById('printItemsWaiting');
                const contracted = document.getElementById('printItemsContracted');

                let targetSection = null;
                if (waiting && waiting.style.display !== 'none') {
                    targetSection = waiting;
                } else if (contracted && contracted.style.display !== 'none') {
                    targetSection = contracted;
                }

                if (!targetSection) return;

                const checkboxes = targetSection.querySelectorAll('.print-item');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
            });
        });


</script>

<script>
    function toggleAllStatus(tabId) {
        const master = document.getElementById(`select_all_status_${tabId}`);
        const checkboxes = document.querySelectorAll(`input[id^="status_"][id$="_${tabId}"]`);
        checkboxes.forEach(cb => cb.checked = master.checked);
        updateStatusCount(tabId);
    }

    function updateStatusCount(tabId) {
        const checkedCount = document.querySelectorAll(`input[name="status"]:checked`).length;
        const button = document.querySelector(`.search-toolbar[data-tab="${tabId}"] .dropdown-toggle`);
        const span = button?.querySelector('.selected-count');
        if (span) {
            span.textContent = checkedCount > 0 ? `(${checkedCount})` : '';
        }
    }

    // بعد از لود صفحه و هر تغییر وضعیت
    document.addEventListener('DOMContentLoaded', () => {
        {% if tab_id %}{% if tab_id|get_status_choices %}updateStatusCount('{{ tab_id }}');
        {% endif %}{% endif %}
    });
    document.addEventListener('change', (e) => {
        if (e.target.name === 'status' || e.target.id?.includes('select_all_status')) {
            const tabId = e.target.id.split('_').pop();
            updateStatusCount(tabId);
        }
    });
</script>


<!-- ************************************************ Search Menu *********************************************** -->
<script>
    document.addEventListener('DOMContentLoaded', function () {

        function initFilter(toolbar) {
            const tabId = toolbar.dataset.tabId;
            const container = document.getElementById('cards-' + tabId);
            if (!container || container.dataset.initialized) return;

            const cards = container.querySelectorAll('.card-wrapper');
            if (cards.length === 0) return;

            container.dataset.initialized = 'true';

            function filterCards() {
                const text = (toolbar.querySelector('input[name="part"]')?.value || '').toLowerCase().trim();
                const from = toolbar.querySelector('input[name="from_date"]')?.value || '';
                const to = toolbar.querySelector('input[name="to_date"]')?.value || '';
                const statuses = Array.from(toolbar.querySelectorAll('input[name="status"]:checked'))
                    .map(cb => (cb.value || '').toLowerCase());

                let visible = 0;
                cards.forEach(card => {
                    const s = (card.dataset.subject || '').toLowerCase();
                    const c = card.dataset.code || '';
                    const d = card.dataset.date || '';
                    const st = (card.dataset.status || '').toLowerCase();

                    const match =
                        (!text || s.includes(text) || c.includes(text)) &&
                        (!from || d >= from) &&
                        (!to || d <= to) &&
                        (statuses.length === 0 || statuses.includes(st));

                    card.style.display = match ? '' : 'none';
                    if (match) visible++;
                });

                let msg = container.querySelector('.no-results');
                if (visible === 0 && cards.length > 0) {
                    if (!msg) {
                        msg = document.createElement('div');
                        msg.className = 'col-12 text-center py-5 no-results';
                        msg.innerHTML = '<h5 class="text-muted">موردی یافت نشد :(</h5>';
                        container.appendChild(msg);
                    }
                } else if (msg) msg.remove();
            }

            toolbar.querySelector('input[name="part"]')?.addEventListener('keyup', () => {
                clearTimeout(window.ft);
                window.ft = setTimeout(filterCards, 300);
            });

            toolbar.querySelector('input[name="from_date"]')?.addEventListener('change', filterCards);
            toolbar.querySelector('input[name="to_date"]')?.addEventListener('change', filterCards);

            toolbar.addEventListener('change', e => {
                if (e.target.name === 'status') filterCards();
            });

            toolbar.querySelector('button[title="نمایش همه"]')?.addEventListener('click', e => {
                e.preventDefault();
                toolbar.querySelector('input[name="part"]').value = '';
                toolbar.querySelector('input[name="from_date"]').value = '';
                toolbar.querySelector('input[name="to_date"]').value = '';
                toolbar.querySelectorAll('input[name="status"]').forEach(cb => cb.checked = false);
                filterCards();
            });

            filterCards();
        }

        document.querySelectorAll('.search-toolbar[data-tab-id]').forEach(initFilter);

        $(document).on('shown.bs.tab', function () {

            document.querySelectorAll('.search-toolbar[data-tab-id]').forEach(initFilter);
        });
    });
</script>


<!-- ************************************************ show file name when browse it *********************************************** -->
<script>
    // ==== نمایش اسم فایل‌های انتخاب‌شده در دکمه آپلود (جنرال برای همه input فایل‌ها) ====
    document.addEventListener('change', function (e) {
        if (e.target && e.target.type === 'file') {
            const input = e.target;
            const label = input.closest('label') || document.querySelector(`label[for="${input.id}"]`);

            if (!label) return;

            const fileNames = Array.from(input.files)
                .map(file => file.name)
                .join(', ');

            // پیدا کردن span یا متن داخل label
            let displayText = label.querySelector('.file-display-text') || label;

            if (input.files.length === 0) {
                displayText.innerHTML = '<i class="fas fa-upload"></i> آپلود جدید';
            } else if (input.files.length === 1) {
                displayText.innerHTML = `<i class="fas fa-check text-success"></i> ${fileNames}`;
            } else {
                displayText.innerHTML = `<i class="fas fa-check text-success"></i> ${input.files.length} فایل انتخاب شد`;
            }
        }
    });
</script>


<!-- ************************************************ Persian number maker *********************************************** -->
<script>
    function toPersianNumber(value, defaultValue = '—') {
        if (value === null || value === undefined || value === '') {
            return defaultValue;
        }

        // تبدیل به رشته و پاک کردن کاراکترهای غیرعددی (به جز - و . و ,)
        let str = String(value).trim();
        let cleaned = str.replace(/[^\d.,-]/g, '');

        if (!cleaned) return defaultValue;

        // حذف کاماهای موجود
        cleaned = cleaned.replace(/,/g, '');

        // فقط بخش عدد صحیح (قبل از نقطه)
        if (cleaned.includes('.')) {
            cleaned = cleaned.split('.')[0];
        }

        // تبدیل به عدد
        let num = parseInt(cleaned, 10);
        if (isNaN(num)) return defaultValue;

        // جدا کردن هزارگان با کاما
        let formatted = num.toLocaleString('en-US');

        // تبدیل کاما به ویرگول فارسی + تبدیل اعداد به فارسی
        const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
        const englishDigits = '0123456789';

        return formatted
            .replace(/,/g, '،')
            .split('')
            .map(char => englishDigits.includes(char) ? persianDigits[englishDigits.indexOf(char)] : char)
            .join('');
    }
</script>


<!-- ************************************************ APPENDIX *********************************************** -->
<script>

    // Function to load contract dynamically
    function loadAppendix() {
        $('#contract_title').select2({
            dir: 'rtl',
            placeholder: 'جستجوی قرارداد...',
            allowClear: true,
            ajax: {
                url: '/contractDashboard/contractListAppendix/', // Replace with actual API endpoint
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {q: params.term || ''};
                },
                processResults: function (data) {
                    return {results: data.results};
                },
                cache: true,
                error: function (xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطا',
                        text: 'خطا در بارگذاری لیست قراردادها',
                        confirmButtonText: 'باشه'
                    });
                    console.error('Error loading services:', error);
                }
            },
            minimumInputLength: 0,
            width: '100%'
        });
    }

    // Function to load contractors
    function loadContractors() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/contractDashboard/contractCompanyList/',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    const $select = $('#contractor');
                    $select.empty();
                    $select.append('<option value="0">انتخاب پیمانکار</option>');
                    $.each(data.results, function (index, contractor) {
                        $select.append(
                            $('<option></option>').val(contractor.id).text(contractor.text)
                        );
                    });
                    resolve();
                },
                error: function (xhr, status, error) {
                    console.error('Error loading contractors:', error);
                    $('#contractor').empty().append('<option value="0">خطا در بارگذاری</option>');
                    reject(error);
                }
            });
        });
    }

    // Function to load projects
    function loadProjects() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/contractDashboard/contractProjectList/',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    const $select = $('#project_name');
                    $select.empty();
                    $select.append('<option value="0">انتخاب پروژه</option>');
                    $.each(data.projects, function (index, project) {
                        $select.append(
                            $('<option></option>').val(project.name).text(project.name)
                        );
                    });
                    resolve();
                },
                error: function (xhr, status, error) {
                    console.error('Error loading projects:', error);
                    $('#project_name').empty().append('<option value="0">خطا در بارگذاری</option>');
                    reject(error);
                }
            });
        });
    }


    // Load dynamic data on page load
    $(document).ready(function () {
        loadAppendix();
        loadContractors();
        loadProjects();

    });


    setInterval(function () {
        const modal = document.querySelector('#addAppendixModal');
        if (!modal) return;

        // فقط وقتی مودال بازه و قبلاً این کد اجرا نشده
        if (modal.classList.contains('show') && !modal.dataset.initialized) {
            console.log("مودال باز شد! حالا کد اجرا میشه");

            function updateFields() {
                // پیش پرداخت
                const p = document.getElementById('prepayment_check');
                if (p) {
                    const checked = p.checked;
                    document.getElementById('prepayment_percentage').disabled = !checked;
                    document.getElementById('prepayment_amount').disabled = !checked;
                }

                // حسن انجام کار
                const g = document.getElementById('has_guarantee');
                if (g) document.getElementById('guarantee_percentage').disabled = !g.checked;

                // تضمین تعهدات
                const a = document.getElementById('has_assurance');
                if (a) document.getElementById('assurance_percentage').disabled = !a.checked;

                // کسورات بیمه
                const w = document.getElementById('has_withholding');
                if (w) document.getElementById('withholding_percentage').disabled = !w.checked;

                // مجوز
                const l = document.getElementById('attachlicense');
                if (l) {
                    const checked = l.checked;
                    document.getElementById('attachlicense_code').disabled = !checked;
                    document.getElementById('attachlicense_file').disabled = !checked;
                }

                // فایل الحاقیه
                const f = document.getElementById('attach');
                if (f) {
                    const checked = f.checked;
                    document.getElementById('attach_code').disabled = !checked;
                    document.getElementById('attach_file').disabled = !checked;
                }
            }

            // اجرا کن
            updateFields();

            // هر وقت چک‌باکس تغییر کرد
            modal.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', updateFields);
            });

            // علامت بزن که دیگه تکرار نشه
            modal.dataset.initialized = 'true';
        }

        // وقتی مودال بسته شد → علامت رو پاک کن تا دفعه بعد دوباره اجرا بشه
        if (!modal.classList.contains('show') && modal.dataset.initialized) {
            modal.dataset.initialized = '';
        }
    }, 300); // هر ۰.۳ ثانیه چک می‌کنه

    // Submit Appendix Form - Final & Production-Ready Version
    $('#submitAppendix').off('click').on('click', function () {
        const $btn = $(this);
        const $form = $('#addAppendixForm');
        const $modal = $('#addAppendixModal');

        // Prevent double-click
        if ($btn.prop('disabled')) return;

        // Disable button + show loading state
        $btn.prop('disabled', true)
            .html('<i class="fas fa-spinner fa-spin"></i> در حال ذخیره سازی ...');

        // --- Validation: Contract must be selected ---
        const contractId = $('#contract_title').val();

        if (!contractId || contractId === '' || contractId === '0') {
            Swal.fire({
                icon: 'warning',
                title: 'هشدار',
                text: ' قرارداد را انتخاب نمایید',
                confirmButtonText: 'تایید'
            });
            $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i> ذخیره اطلاعات');
            return;
        }

        // --- Validation: Appendix type must be selected ---
        const appendixType = $('input[name="appendix_type"]:checked').val();

        if (!appendixType) {
            Swal.fire({
                icon: 'warning',
                title: 'هشدار',
                text: 'نوع الحاقیه را انتخاب نمایید.',
                confirmButtonText: 'تایید'
            });
            $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i> ذخیره اطلاعات');
            return;
        }

        // Prepare FormData (supports file uploads)
        const formData = new FormData($form[0]);

        // Explicitly add important fields (Select2 only sends value, not hidden fields sometimes)
        formData.append('contract_id', contractId);
        formData.append('appendix_type', appendixType);

        $.ajax({
            url: '/contractDashboard/contractAddAppendix/',
            type: 'POST',
            data: formData,
            processData: false,   // Required for file upload
            contentType: false,   // Required for file upload
            cache: false,
            timeout: 30000,       // 30 second timeout

            success: function (response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'موفق!',
                        text: response.message || 'الحاقیه با موفقیت ذخیره گردید.',
                        timer: 2000,
                        showConfirmButton: false
                    });

                    // Close modal
                    $modal.modal('hide');

                    // Reset form completely
                    $form[0].reset();
                    $('#contract_title').val(null).trigger('change'); // Important for Select2
                    $('input[type="radio"][name="appendix_type"]:first').prop('checked', true);
                    $('input[type="checkbox"]').prop('checked', false).trigger('change');

                    // Optional: reload current tab/page
                    window.location.reload()

                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطا',
                        text: response.message || 'خطا در ذخیره سازی الحاقیه',
                        confirmButtonText: 'تایید'
                    });
                }
            },

            error: function (jqXHR, textStatus, errorThrown) {
                console.error('AJAX Error:', jqXHR.responseText || textStatus);

                let msg = 'خطا در ارتباط با سرور';
                if (jqXHR.status === 400) msg = 'خطا در دیتای ارسالی';
                if (jqXHR.status === 403) msg = 'شما دسترسی ندارید.';
                if (jqXHR.status === 500) msg = 'خطای سرور.لطفا دوباره سعی نمایید.';

                Swal.fire({
                    icon: 'error',
                    title: 'خطا در اتصال به سرور',
                    text: msg,
                    confirmButtonText: 'تایید'
                });
            },

            complete: function () {
                // Re-enable button and restore original text
                $btn.prop('disabled', false)
                    .html('<i class="fas fa-save me-2"></i> ذخیره اطلاعات');
            }
        });
    });


    function onContractSelected(selectElement) {
        const $select = $(selectElement);
        const selectedText = $select.find('option:selected').text(); // مثلاً: "خرید باتری [C1404001]"

        // Extract text inside square brackets [C1404001]
        const match = selectedText.match(/\[(.*?)\]/);
        const contractCode = match ? match[1] : '';

        // Fill the contract code field
        $('#contract_code').val(contractCode);

    }

    // When user clears the selection in Select2
    $(document).on('select2:clear', '#contract_title', function () {
        $('#contract_code').val('');
    });

</script>


<script>
    // تبدیل عدد انگلیسی به فارسی (فقط برای نمایش)
    function toPersianDigits(str) {
        const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        return str.toString().replace(/[0-9]/g, w => persian[w]);
    }

    // تبدیل اعداد فارسی/عربی به انگلیسی (برای پردازش)
    function toEnglishDigits(str) {
        const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        const arabic = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        let result = str;
        persian.forEach((d, i) => result = result.replace(new RegExp(d, 'g'), i));
        arabic.forEach((d, i) => result = result.replace(new RegExp(d, 'g'), i));
        return result;
    }

    // فرمت عدد با کاما (هر ۳ رقم)
    function formatNumber(n) {
        return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // اعمال روی همه اینپوت‌های با کلاس persian-number
    document.querySelectorAll('.persian-number').forEach(input => {
        input.addEventListener('input', function (e) {
            // ۱. مقدار فعلی رو بگیر
            let value = this.value;

            // ۲. اعداد فارسی یا عربی رو به انگلیسی تبدیل کن
            value = toEnglishDigits(value);

            // ۳. فقط عدد نگه دار (هیچ چیز دیگه‌ای قبول نکن)
            value = value.replace(/[^0-9]/g, '');

            // ۴. اگر خالی بود، پاک کن
            if (value === '' || value === '0') {
                this.value = '';
                this.dataset.value = '';
                return;
            }

            // ۵. عدد تمیز (انگلیسی)
            const cleanNumber = parseInt(value, 10);

            // ۶. ذخیره عدد تمیز در data-attribute (برای ارسال به سرور)
            this.dataset.value = cleanNumber;

            // ۷. اول کاما بزن (روی عدد انگلیسی)
            const withComma = formatNumber(cleanNumber);        // مثال: 1234567890 → 1,234,567,890

            // ۸. بعد فارسی کن (کاما انگلیسی باقی می‌مونه)
            const finalDisplay = toPersianDigits(withComma);     // → ۱,۲۳۴,۵۶۷,۸۹۰

            // ۹. نمایش نهایی در اینپوت
            this.value = finalDisplay;
        });

        // وقتی فوکوس از دست رفت (اختیاری: صفرهای اضافی حذف بشه)
        input.addEventListener('blur', function () {
            if (this.value === '' || this.value === '۰') {
                this.value = '';
                this.dataset.value = '';
            }
        });
    });
</script>








